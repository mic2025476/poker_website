{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}
{% block content %}
<style>
  /* ===========================
     THEME TOKENS (3 OPTIONS)
     =========================== */
  :root {
    /* default = monochrome so it also works if JS is off */
    --theme-primary: #d9d9d9;
    --theme-primary-hover: #f5f5f5;
    --theme-primary-light: rgba(255, 255, 255, 0.3);

    /* text color on primary buttons */
    --btn-cta-text: #000000;

    /* active tab text */
    --tab-active-text-color: #000000;

    /* map to old variable names */
    --theme-red: var(--theme-primary);
    --theme-red-hover: var(--theme-primary-hover);
    --theme-red-light: var(--theme-primary-light);
  }

  /* Option 1: Monochrome (B/W) */
  :root[data-theme="monochrome"] {
    --theme-primary: #d9d9d9;
    --theme-primary-hover: #f5f5f5;
    --theme-primary-light: rgba(255, 255, 255, 0.3);

    --btn-cta-text: #000000;
    --tab-active-text-color: #000000;

    --theme-red: var(--theme-primary);
    --theme-red-hover: var(--theme-primary-hover);
    --theme-red-light: var(--theme-primary-light);
  }

  /* Option 2: Blue Table (taken from table felt) */
  :root[data-theme="blue-table"] {
    --theme-primary: #2457b6; /* main blue */
    --theme-primary-hover: #3b6fd4;
    --theme-primary-light: rgba(36, 87, 182, 0.28);

    --btn-cta-text: #ffffff;        /* white text on blue */
    --tab-active-text-color: #ffffff;

    --theme-red: var(--theme-primary);
    --theme-red-hover: var(--theme-primary-hover);
    --theme-red-light: var(--theme-primary-light);
  }

  /* Option 3: Gold & Black (matches brass cup holders) */
  :root[data-theme="gold-classic"] {
    --theme-primary: #e4b34c;
    --theme-primary-hover: #f3c667;
    --theme-primary-light: rgba(228, 179, 76, 0.25);

    --btn-cta-text: #000000;
    --tab-active-text-color: #000000;

    --theme-red: var(--theme-primary);
    --theme-red-hover: var(--theme-primary-hover);
    --theme-red-light: var(--theme-primary-light);
  }

  /* ===========================
     AUTH MODAL
     =========================== */
#authForm {
  position: fixed;
  z-index: 1050;
  /* centered by default */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);

  /* dynamic width */
  width: clamp(320px, 90vw, 420px);

  /* dynamic height */
  max-height: 78vh;              /* never taller than viewport */
  overflow-y: auto;

  background-color: #fff;
  padding: clamp(0.75rem, 2vw, 1.4rem);  /* padding shrinks on small screens */
  border-radius: 0.75rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);

  display: flex;
  flex-direction: column;

  backdrop-filter: blur(10px);
  animation: slideInModal 0.3s ease-out;
  transition: all 0.2s ease;
}



  @media (min-width: 1280px) {
    #authForm {
      width: 480px;
      max-width: 90vw;
      padding: 2rem;
    }
  }

  #authForm.d-none {
    animation: slideOutModal 0.2s ease-in;
    pointer-events: none;
  }

  #authForm .nav-tabs {
    position: sticky;
    top: 0;
    background-color: white;
    z-index: 10;
    padding: 0.5rem 0;
    border-bottom: none;
    justify-content: center;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 0.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  #authForm .tab-content {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.25rem;
  }

  #authForm .sticky-footer {
    position: sticky;
    bottom: 0;
    background-color: white;
    z-index: 10;
    padding: 0.5rem 0;
    border-top: 1px solid #ddd;
  }

  .nav-tabs .nav-link {
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 2rem;
    margin: 0 0.25rem;
    transition: all 0.3s ease;
    color: #6c757d;
    background: transparent;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
  }

  .nav-tabs .nav-link:hover {
    color: #000;
    background: var(--theme-red-light);
    transform: translateY(-1px);
  }

  .nav-tabs .nav-link.active {
    color: var(--tab-active-text-color);
    background: linear-gradient(135deg, var(--theme-red) 0%, var(--theme-red-hover) 100%);
    box-shadow: 0 4px 15px var(--theme-red-light);
    transform: translateY(-2px);
  }

  .nav-tabs .nav-link.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    pointer-events: none;
  }

.form-label {
    font-size: 0.62rem;   /* slightly smaller */
    font-weight: 500;     /* lighter */
    letter-spacing: 0.3px;
    margin-bottom: 0.1rem;
    color: #555;
}


  #authForm .form-control {
      font-size: 0.85rem;
      padding: 0.65rem 0.75rem;
      height: 42px; /* consistent height */
      border: 1px solid #dcdcdc;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
      background-color: #f8f9fa;
      transition: all 0.2s ease-in-out;
  }

  #authForm .input-group-text {
    height: 42px;
    padding: 0 0.75rem;
    border-radius: 0.5rem 0 0 0.5rem;
}

#authForm .input-group .form-control {
    height: 42px; /* match text addon */
    border-radius: 0 0.5rem 0.5rem 0;
}


  @media (min-width: 1280px) {
    #authForm .form-control {
      font-size: var(--font-size-base);
      padding: 0.875rem 1rem;
    }
  }

  #authForm .form-control:focus {
    border-color: var(--theme-red);
    box-shadow: 0 0 0 3px var(--theme-red-light);
    background-color: white;
    outline: none;
  }

  .input-group {
    margin-bottom: 0.5rem;
    border-radius: 0.4rem;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
  }

  .input-group-text {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-right: none;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 2.2rem;
    transition: all 0.2s ease-in-out;
  }

  #authForm .input-group:focus-within .input-group-text {
    border-color: var(--theme-red);
    background-color: white;
    color: #000;
  }

  #authForm .input-group:focus-within .form-control {
    border-color: var(--theme-red);
    background-color: white;
  }

  /* Auth buttons */
  .btn-auth {
    background-color: var(--theme-red);
    border: none;
    color: var(--btn-cta-text);
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.6rem;
    width: 100%;
    border-radius: 0.4rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px var(--theme-red-light);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    min-height: 38px;
    touch-action: manipulation;
  }

  .btn-google {
    font-size: 0.75rem;
    padding: 0.4rem;
  }

  .btn-auth:hover {
    background-color: var(--theme-red-hover);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--theme-red-light);
  }

  .btn-auth:active {
    transform: translateY(0px);
    transition: all 0.1s ease;
  }

  .btn-google {
    background-color: white;
    border: 1px solid #e9ecef;
    color: #333;
    font-size: 0.8rem;
    font-weight: 500;
    padding: 0.55rem;
    width: 100%;
    border-radius: 0.4rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    min-height: 38px;
    touch-action: manipulation;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
  }

  .btn-google:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    background-color: #f8f9fa;
    transform: translateY(-1px);
    border-color: #dee2e6;
  }

  .btn-google:active {
    transform: translateY(0px);
    transition: all 0.1s ease;
  }

  .divider {
    text-align: center;
    margin: 0.75rem 0;
    position: relative;
    color: #999;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #ddd;
    z-index: 1;
  }

  .divider span {
    background: white;
    padding: 0 0.75rem;
    position: relative;
    z-index: 2;
  }

  .close-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #f8f9fa;
    border: none;
    font-size: 1.5rem;
    color: #666;
    cursor: pointer;
    z-index: 11;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    touch-action: manipulation;
  }

  .close-btn:hover {
    background: #e9ecef;
    color: #333;
    transform: scale(1.1);
  }

  .text-muted-small {
    font-size: 0.7rem;
    color: #666;
  }

  /* Monochrome-style OTP states */
  .otp-error {
    color: #333;
    font-size: 0.7rem;
    margin-top: 0.2rem;
  }

  .otp-success {
    color: #666;
    font-size: 0.7rem;
    margin-top: 0.2rem;
  }

  .is-invalid {
    border-color: #444 !important;
  }

  .is-valid {
    border-color: #888 !important;
  }

@media (max-width: 576px) {
  .form-label {
    font-size: 0.7rem;
  }

  #authForm {
    width: 92%;
    max-width: 380px;
    max-height: 90vh;
    padding: 0.75rem;
    border-radius: 0.6rem;
    top: 54%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  #authForm .form-control {
    font-size: 16px;
    padding: 0.4rem 0.55rem;
    height: 2.2rem;
  }

  .input-group-text {
    font-size: 12px;
    height: 2.2rem;
    padding: 0.4rem 0.5rem;
  }

  .btn-auth {
    font-size: 0.8rem;
    padding: 0.5rem;
    min-height: 36px;
  }

  .btn-google {
    font-size: 0.75rem;
    padding: 0.45rem;
    min-height: 36px;
  }

  #authForm .nav-tabs .nav-link {
    font-size: 0.8rem;
    padding: 0.5rem 1rem;
    margin: 0 0.15rem;
  }

  .close-btn {
    top: 0.3rem;
    right: 0.3rem;
    width: 28px;
    height: 28px;
    font-size: 1.1rem;
  }
}


/* Phones and small tablets */
@media (max-width: 768px) {
  #hero {
    /* on phones, use even smaller file */
    background-image: url("{% static 'mge_pictures/thumbs/DSC_0009.JPG' %}");
    background-attachment: scroll; /* avoids jank on iOS */
  }
  #authForm {
    width: 92vw;
    max-width: 380px;
    max-height: 82vh;                      /* a bit shorter on phones */
    padding: clamp(0.6rem, 2vw, 1rem);
    border-radius: 0.6rem;
    top: 52%;                              /* slightly lower than perfect center */
    transform: translate(-50%, -50%);
  }

  #authForm .form-label {
    font-size: clamp(0.7rem, 2.8vw, 0.85rem);
  }

  #authForm .form-control {
    font-size: 16px;                       /* avoids iOS auto-zoom */
    padding: 0.4rem 0.55rem;
    height: 2.2rem;
  }

  #authForm .nav-tabs .nav-link {
    font-size: 0.8rem;
    padding: 0.45rem 0.8rem;
  }

  .btn-auth {
    font-size: 0.8rem;
    padding: 0.5rem;
    min-height: 36px;
  }
}

/* Very short screens (small iPhones / landscape) */
@media (max-height: 700px) and (max-width: 768px) {
  #authForm {
    top: 50%;            /* keep more centered on very short screens */
    max-height: 78vh;    /* a bit shorter */
  }
}

  /* ===========================
     HERO
     =========================== */
#hero {
    /* use optimized hero image (resized version) */
    background-image: url("{% static 'mge_pictures/full/DSC_0009.JPG' %}");
    background-size: cover;
    background-position: center;
    padding: clamp(3rem, 8vh, 10rem) var(--container-gutter);
    text-align: center;
    min-height: 100vh;
    background-attachment: fixed;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}


  #hero::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 1;
  }

  #hero > * {
    position: relative;
    z-index: 2;
  }

  #hero .text-center {
    max-width: 900px;
    margin: 0 auto;
  }

  #hero h1 {
    font-size: var(--font-h1);
    font-weight: 700;
    margin-bottom: var(--space-6);
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
    line-height: var(--line-height-tight);
  }

  #hero p {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-7);
    font-weight: 300;
    text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.4);
    max-width: 60ch;
    margin-left: auto;
    margin-right: auto;
  }

  #hero .btn {
    font-size: clamp(1rem, 0.95rem + 0.25vw, 1.25rem);
    padding: clamp(0.875rem, 1vw, 1.25rem) clamp(2rem, 3vw, 3.5rem);
    font-weight: 600;
    border-radius: 50px;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px var(--theme-red-light);
  }

  #hero .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--theme-red-light);
  }

  #hero .btn:focus {
    outline: 3px solid #fff;
    outline-offset: 4px;
  }

  @media (max-width: 576px) {
    #hero {
      padding: 2rem 1rem;
      min-height: 100vh;
      background-attachment: scroll;
    }

    #hero h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }

    #hero p {
      font-size: 1rem;
      margin-bottom: 2rem;
    }

    #hero .btn {
      font-size: 1rem;
      padding: 0.75rem 2rem;
      width: auto;
      min-width: 200px;
    }
  }

  .custom-red-button {
    background-color: var(--theme-red) !important;
    border-color: var(--theme-red) !important;
    color: var(--btn-cta-text) !important;
    transition: background-color 0.3s, border-color 0.3s;
  }

  .custom-red-button:hover {
    background-color: var(--theme-red-hover) !important;
    border-color: var(--theme-red-hover) !important;
  }

  /* ===========================
     THEME SWITCHER (BOTTOM RIGHT)
     =========================== */
  .theme-switcher {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    z-index: 1200;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.4rem;
  }

  .theme-switcher-label {
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.7);
    color: #ffffff;
  }

  .theme-switcher-dots {
    display: flex;
    gap: 0.35rem;
    padding: 0.25rem 0.4rem;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(4px);
  }

  .theme-dot {
    width: 16px;
    height: 16px;
    border-radius: 999px;
    border: 2px solid #ffffff;
    cursor: pointer;
    opacity: 0.75;
    transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
  }

  .theme-dot--mono {
    background: #d9d9d9;
  }

  .theme-dot--blue {
    background: #2457b6;
  }

  .theme-dot--gold {
    background: #e4b34c;
  }

  .theme-dot:hover,
  .theme-dot.theme-dot-active {
    opacity: 1;
    transform: scale(1.12);
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.6);
  }

  @media (max-width: 576px) {
    .theme-switcher {
      right: 0.75rem;
      bottom: 0.75rem;
    }
    .theme-switcher-label {
      display: none;
    }
  }

  /* ===========================
     ANIMATIONS / MISC
     =========================== */
  @keyframes slideInModal {
    from {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
    }
    to {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
  }

  @keyframes slideOutModal {
    from {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    to {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
    }
  }

  @keyframes fadeInUp {
    from {
      transform: translateY(30px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 4px 15px var(--theme-red-light);
    }
    50% {
      box-shadow: 0 6px 20px var(--theme-red-light);
    }
    100% {
      box-shadow: 0 4px 15px var(--theme-red-light);
    }
  }

  html {
    scroll-behavior: smooth;
  }

  /* Add animation to form inputs */
  .form-control,
  .input-group-text {
    animation: fadeInUp 0.3s ease-out;
  }

  .form-control:nth-child(1) { animation-delay: 0.1s; }
  .form-control:nth-child(2) { animation-delay: 0.2s; }
  .form-control:nth-child(3) { animation-delay: 0.3s; }
  .form-control:nth-child(4) { animation-delay: 0.4s; }

  /* Pulse animation for CTA button */
  #hero .btn {
    animation: pulse 3s infinite;
  }

  @media (max-width: 576px) {
    #authForm {
      animation: slideInModal 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    #authForm.d-none {
      animation: slideOutModal 0.2s cubic-bezier(0.55, 0.06, 0.68, 0.19);
    }

    .form-control,
    .input-group-text,
    .btn-auth,
    .btn-google {
      transition: all 0.2s ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  }

  /* Password toggle styles */
.password-toggle {
    height: 42px !important;
    display: flex;
    align-items: center;
    justify-content: center;
    border-left: none !important;
    border-radius: 0 0.5rem 0.5rem 0 !important;
}


  .password-toggle:hover {
    background-color: #e9ecef !important;
    color: #000 !important;
  }

  .password-toggle i {
    font-size: 0.9rem;
  }
/* Fine-tune reset password buttons inside auth card */
#resetPasswordSection .btn-auth {
  font-size: 0.8rem;
  padding: 0.55rem 0.75rem;
  margin-bottom: 0;
}

#resetPasswordSection #rpBackBtn {
  font-size: 0.75rem;
  padding: 0.35rem 0.75rem;
}
.btn-google i.bi-google {
  font-size: 1rem;
  vertical-align: middle;
}
#signupStatus {
  margin-bottom: 0.75rem;
  font-size: 0.9rem;
}

/* Container */
.signup-terms {
  display: flex;
  align-items: center;
  flex-wrap: nowrap;       /* üö´ don't wrap onto a second line */
  gap: 0.4rem;
  margin-bottom: 0.5rem;
}

/* Label with checkbox + text side by side */
.signup-terms-label {
  white-space: nowrap;     /* üö´ keep the entire sentence on ONE line */
  font-size: 0.8rem;
  color: black;           /* adjust to your theme text color */
  overflow: hidden;        /* if it's too long on tiny screens: */
  text-overflow: ellipsis; /* ... show "..." at the end instead of wrapping */
}

/* Text color so it looks like subtle legal text */
.signup-terms-text {            /* change to your theme's muted text color if needed */
  line-height: 1.3;
}
/* Checkbox alignment */
.signup-terms-checkbox {
  margin-top: 0.2rem;
}

/* Links in the text: match your accent color */
.signup-terms-link {
  /* Replace this with your poker brand color if you have one,
     or use Bootstrap class .text-warning / .text-primary */
  color: black;            /* example golden accent */
  text-decoration: underline;
}

.signup-terms-link:hover {
  text-decoration: none;
}

/* Error message below the checkbox */
.signup-terms-error {
  margin-top: -0.4rem;
  margin-bottom: 0.5rem;
  font-size: 0.78rem;
  color: #dc3545;           /* Bootstrap danger red */
}

</style>

<!-- Auth Form -->
<div id="authForm" class="d-none" data-is-authenticated="{% if request.session.user_id %}true{% else %}false{% endif %}">
  <button class="close-btn" onclick="document.getElementById('authForm').classList.add('d-none')">&times;</button>
  
  <ul class="nav nav-tabs" id="authTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active fw-semibold" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup" type="button" role="tab" aria-controls="signup" aria-selected="true">
        {% trans "Sign Up" %}
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-semibold" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab" aria-controls="login" aria-selected="false">
        {% trans "Login" %}
      </button>
    </li>
  </ul>

  <div class="tab-content" id="authTabContent">
    <!-- Sign Up Tab -->
    <div class="tab-pane fade show active" id="signup" role="tabpanel" aria-labelledby="signup-tab">
      <div id="signupStatus" class="alert d-none" role="alert"></div>
      <form id="signupForm">
        <div class="mb-2">
          <label for="signupFirstName" class="form-label">{% trans "First Name" %}</label>
          <input type="text" class="form-control" id="signupFirstName" name="first_name" placeholder="{% trans 'Enter your first name' %}" required />
        </div>
        <div class="mb-2">
          <label for="signupLastName" class="form-label">{% trans "Last Name" %}</label>
          <input type="text" class="form-control" id="signupLastName" name="last_name" placeholder="{% trans 'Enter your last name' %}" required />
        </div>
        <div class="mb-2">
          <label for="signupEmail" class="form-label">{% trans "Email" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
            <input type="email" class="form-control" id="signupEmail" name="email_id" placeholder="yourname@example.com" required />
          </div>
        </div>
        <div class="mb-2">
          <label for="signupPassword" class="form-label">{% trans "Password" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            <input type="password" class="form-control" id="signupPassword" name="password" placeholder="{% trans 'Enter your password' %}" required />
            <span class="input-group-text password-toggle" onclick="togglePassword('signupPassword')">
              <i class="bi bi-eye" id="signupPasswordIcon"></i>
            </span>
          </div>
        </div>
        <div class="mb-3">
          <label for="signupConfirmPassword" class="form-label">{% trans "Confirm Password" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
            <input type="password" class="form-control" id="signupConfirmPassword" name="confirm_password" placeholder="{% trans 'Re-enter your password' %}" required />
            <span class="input-group-text password-toggle" onclick="togglePassword('signupConfirmPassword')">
              <i class="bi bi-eye" id="signupConfirmPasswordIcon"></i>
            </span>
          </div>
        </div>
      </form>

      <!-- OTP Verification Section (Hidden initially) -->
      <div id="signupOtpSection" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0" style="font-size: 0.9rem;">{% trans "Verify your account" %}</h6>
          <button type="button" id="backToSignupBtn" class="btn btn-link p-0" style="font-size: 0.8rem;">{% trans "Back" %}</button>
        </div>
        <p class="text-muted-small mb-2" id="otpHint"></p>

        <div class="mb-2">
          <label for="emailOtp" class="form-label">{% trans "Email OTP" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-shield-check"></i></span>
            <input type="text" class="form-control" id="emailOtp" placeholder="{% trans 'Enter email OTP' %}" />
          </div>
          <div id="emailOtpError" class="otp-error d-none">{% trans "Please enter the email OTP." %}</div>
        </div>

        <div class="d-grid gap-2">
          <button type="button" id="verifyOtpBtn" class="btn-auth">
            {% trans "Verify OTP" %}
          </button>
          <button type="button" id="resendEmailOtpBtn" class="btn btn-outline-secondary btn-sm">
            {% trans "Resend Email OTP" %}
          </button>
        </div>
        <div id="otpStatus" class="mt-2"></div>
      </div>
    </div>

    <!-- Login Tab -->
    <div class="tab-pane fade" id="login" role="tabpanel" aria-labelledby="login-tab">
      <form id="loginForm">
        <div class="mb-2">
          <label for="loginEmail" class="form-label">{% trans "Email" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
            <input type="email" class="form-control" id="loginEmail" name="email_id" placeholder="yourname@example.com" required />
          </div>
        </div>
        <div class="mb-3">
          <label for="loginPassword" class="form-label">{% trans "Password" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            <input type="password" class="form-control" id="loginPassword" name="password" placeholder="{% trans 'Enter your password' %}" required />
            <span class="input-group-text password-toggle" onclick="togglePassword('loginPassword')">
              <i class="bi bi-eye" id="loginPasswordIcon"></i>
            </span>
          </div>
        </div>
        <div class="d-flex justify-content-end mb-3">
        <a href="#"
          id="forgotPasswordLink"
          class="small text-decoration-underline">
          {% trans "Forgot password?" %}
        </a>
        </div>

        <div id="loginMessage" style="color: #b00020; margin-bottom: 0.75rem; font-size: 0.8rem;"></div>
      </form>
      <!-- Reset Password Section (hidden initially) -->
      <div id="resetPasswordSection" class="d-none mt-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0" style="font-size: 0.9rem;">
            {% trans "Reset your password" %}
          </h6>
          <button type="button" id="backToLoginFromReset"
                  class="btn btn-link p-0" style="font-size: 0.8rem;">
            {% trans "Back to login" %}
          </button>
        </div>

        <p class="text-muted-small mb-2" id="rpStepText">Step 1/3 ‚Äì Enter email</p>

        <!-- STEP 1: email -->
        <div class="rp-step" data-step="1">
          <div class="mb-2">
            <label for="forgotEmail" class="form-label">{% trans "Email" %}</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope"></i></span>
              <input type="email"
                     class="form-control"
                     id="forgotEmail"
                     name="email_id"
                     placeholder="yourname@example.com" />
            </div>
            <div class="form-text">
              {% trans "We will send a reset code to this email." %}
            </div>
          </div>
        </div>

        <!-- STEP 2: OTP -->
        <div class="rp-step d-none" data-step="2">
          <div class="mb-2">
            <label for="forgotOtp" class="form-label">{% trans "OTP code" %}</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
              <input type="text"
                     maxlength="6"
                     class="form-control"
                     id="forgotOtp"
                     name="otp"
                     placeholder="{% trans 'Enter the 6-digit code' %}" />
            </div>
            <div class="form-text">
              {% trans "Check your email for the 6-digit code." %}
            </div>
          </div>
        </div>

        <!-- STEP 3: new password -->
        <div class="rp-step d-none" data-step="3">
          <div class="mb-2">
            <label for="forgotNewPassword" class="form-label">{% trans "New password" %}</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-lock"></i></span>
              <input type="password"
                     class="form-control"
                     id="forgotNewPassword"
                     name="password"
                     placeholder="{% trans 'Enter new password' %}" />
              <span class="input-group-text password-toggle"
                    onclick="togglePassword('forgotNewPassword')">
                <i class="bi bi-eye" id="forgotNewPasswordIcon"></i>
              </span>
            </div>
          </div>

          <div class="mb-2">
            <label for="forgotConfirmPassword" class="form-label">{% trans "Confirm new password" %}</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
              <input type="password"
                     class="form-control"
                     id="forgotConfirmPassword"
                     name="confirm_password"
                     placeholder="{% trans 'Confirm new password' %}" />
              <span class="input-group-text password-toggle"
                    onclick="togglePassword('forgotConfirmPassword')">
                <i class="bi bi-eye" id="forgotConfirmPasswordIcon"></i>
              </span>
            </div>
          </div>
        </div>

        <div id="resetPasswordMessage"
             class="text-muted-small mt-1"
             style="min-height: 1rem;"></div>

<div class="d-flex justify-content-between align-items-center mt-3">
  <!-- small subtle back button -->
  <button type="button"
          class="btn btn-outline-secondary btn-sm d-none"
          id="rpBackBtn">
    ‚Üê {% trans "Back" %}
  </button>

  <!-- main CTA, same style as Login / Sign Up -->
  <button type="button"
          class="btn-auth ms-auto"
          style="max-width: 180px;"
          id="rpNextBtn">
    {% trans "Send OTP" %}
  </button>
</div>


      </div>

    </div>
  </div>

  <!-- Sticky Footer with Buttons -->
  <div class="sticky-footer">
    <!-- SIGN UP buttons -->
    <div id="signupButtons">
<div class="signup-terms">
  <input
    type="checkbox"
    id="signupTerms"
    class="form-check-input signup-terms-checkbox"
  />

  <label for="signupTerms" class="signup-terms-label">
    I have read and agree to the
<a href="{% url 'terms' %}" target="_blank" class="signup-terms-link">
  Terms &amp; Conditions
</a>
  </label>
</div>

<div id="signupTermsError" class="signup-terms-error d-none">
  You must accept the terms and privacy policy to sign up.
</div>


<div id="signupTermsError" class="signup-terms-error d-none">
  You must accept the terms and privacy policy to sign up.
</div>



      <button type="submit" form="signupForm" class="btn-auth">
        {% trans "Sign Up" %}
      </button>

      <div class="divider"><span>{% trans "or" %}</span></div>

<button type="button"
        class="btn-google"
        id="googleSignupBtn"
        onclick="signInWithGoogle('signup')">
  <i class="bi bi-google me-2"></i>
  <span>{% trans "Sign up with Google" %}</span>
</button>

    </div>
    <!-- LOGIN buttons (you already had this, just add id) -->
    <div id="loginButtons" class="d-none">
      <button type="submit" form="loginForm" class="btn-auth">
        {% trans "Login" %}
      </button>

      <div class="divider"><span>{% trans "or" %}</span></div>

<button type="button"
        class="btn-google"
        id="googleLoginBtn"
        onclick="signInWithGoogle('login')">
  <i class="bi bi-google me-2"></i>
  <span>{% trans "Continue with Google" %}</span>
</button>

    </div>
  </div>
</div>

<!-- Main Hero Section -->
<section id="hero" class="d-flex flex-column justify-content-center align-items-center">
  <div class="text-center text-white mb-4">
    <h1 class="display-4 fw-bold">{% trans "Welcome to MG-Entertainment's Poker Lounge" %}</h1>
    <p class="lead">{% trans "Berlin's Premier Poker Lounge by MG Entertainment" %}</p>
    <button type="button" class="btn btn-lg mt-3 custom-red-button toggleAuthForm">
      {% trans "Book Your Table Now" %}
    </button>
  </div>
</section>

<!-- Floating Theme Switcher -->
<div id="themeSwitcher" class="theme-switcher">
  <div class="theme-switcher-label">Theme</div>
  <div class="theme-switcher-dots">
    <button type="button" class="theme-dot theme-dot--mono theme-dot-active" data-theme-option="monochrome" title="Monochrome"></button>
    <button type="button" class="theme-dot theme-dot--blue" data-theme-option="blue-table" title="Blue Table"></button>
    <button type="button" class="theme-dot theme-dot--gold" data-theme-option="gold-classic" title="Gold & Black"></button>
  </div>
</div>


<!-- Bootstrap JS (required for modals, etc.) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
<script>
  const scriptUrl = "https://script.google.com/macros/s/AKfycbzjgFhr_1tSuMUTWMutUCpyOYWUcWpOGpY-GO-t_nz75S-13QQt0Wpd3xrFZMeae7OcJw/exec";
  const state = { signupData: null };
  const THEME_KEY = "mg-theme";

  function getCSRFToken() {
    return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
  }

  function togglePassword(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const iconElement = document.getElementById(fieldId + 'Icon');

    if (passwordField.type === 'password') {
      passwordField.type = 'text';
      iconElement.className = 'bi bi-eye-slash';
    } else {
      passwordField.type = 'password';
      iconElement.className = 'bi bi-eye';
    }
  }
  
    function applyTheme(themeName) {
    const allowed = ["monochrome", "blue-table", "gold-classic"];
    if (!allowed.includes(themeName)) themeName = "monochrome";
    document.documentElement.setAttribute("data-theme", themeName);

    document.querySelectorAll(".theme-dot").forEach(dot => {
      dot.classList.toggle("theme-dot-active", dot.dataset.themeOption === themeName);
    });
  }

// OAuth Code Flow (more stable than google.accounts.id.prompt / FedCM)
window._googleCodeClient = null;
window.googleReady = false;

window.initializeGoogleSignIn = function () {
  if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
    window._googleCodeClient = google.accounts.oauth2.initCodeClient({
      client_id: "{{ GOOGLE_CLIENT_ID }}",
      scope: "openid email profile",
      ux_mode: "popup",
      prompt: "select_account",

      callback: (resp) => {
        console.log("‚úÖ Google callback fired:", resp);
        if (!resp || !resp.code) {
          setGoogleButtonLoading(window._googleAuthContext, false);
          alert("Google did not return a code.");
          return;
        }
        handleGoogleOAuthCode(resp.code);
      },

      error_callback: (err) => {
        console.error("‚ùå Google OAuth error_callback:", err);
        setGoogleButtonLoading(window._googleAuthContext, false);
        alert("Google auth failed: " + (err?.type || "unknown"));
      }
    });

    console.log("‚úÖ Google OAuth client ready");
  } else {
    console.warn("google.accounts.oauth2 not available yet");
  }
};

if (typeof window.tryInitGoogle === "function") {
  window.tryInitGoogle();
}
function onGoogleScriptLoad() {
  window.initializeGoogleSignIn();
}
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  if (params.get("openAuth") === "1") {
    if (typeof window.openAuthModal === "function") window.openAuthModal();
  }
  window.initializeGoogleSignIn();
});
function handleGoogleOAuthCode(code) {
  const payload = {
    code: code,
    flow_type: window._googleAuthContext || 'login',
  };

  // for signup enforce terms too
  if (window._googleAuthContext === 'signup') {
    const signupTermsCheckbox = document.getElementById('signupTerms');
    payload.terms_accepted = !!(signupTermsCheckbox && signupTermsCheckbox.checked);
  }

  fetch('/customers/api/google-auth/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    body: JSON.stringify(payload)
  })
  .then(async res => {
    const text = await res.text();
    try { return JSON.parse(text); } 
    catch { throw new Error("Backend returned non-JSON: " + text); }
  })
  .then(result => {
    setGoogleButtonLoading(window._googleAuthContext, false);
    if (result.success) {
      document.getElementById('authForm').classList.add('d-none');
      window.simulateLogin && window.simulateLogin();
      window.location.href = "/bookings/book";
    } else {
      alert(result.message || "Google authentication failed.");
    }
  })
  .catch(err => {
    console.error(err);
    setGoogleButtonLoading(window._googleAuthContext, false);
    alert("Google authentication error. Check console.");
  });
}

// keep track of which button triggered Google
window._googleAuthContext = null;

function setGoogleButtonLoading(type, isLoading) {
  const btnId = type === 'signup' ? 'googleSignupBtn' : 'googleLoginBtn';
  const btn = document.getElementById(btnId);
  if (!btn) return;

  if (isLoading) {
    btn.dataset.originalHtml = btn.dataset.originalHtml || btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>' +
      (type === 'signup' ? 'Connecting‚Ä¶' : 'Signing in‚Ä¶');
  } else {
    btn.disabled = false;
    if (btn.dataset.originalHtml) {
      btn.innerHTML = btn.dataset.originalHtml;
    }
  }
}

async function waitForGoogleReady(timeoutMs = 2500) {
  const start = Date.now();
  while (Date.now() - start < timeoutMs) {
    if (window.googleReady && window._googleCodeClient) return true;
    // try to init again (in case script finished after click)
    if (typeof window.initializeGoogleSignIn === "function") {
      window.initializeGoogleSignIn();
    }
    await new Promise(r => setTimeout(r, 120));
  }
  return false;
}

// Trigger Google Sign-In
function signInWithGoogle(type) {
  window._googleAuthContext = type || 'login';

  // block signup if terms not accepted (keep your existing logic)
  if (window._googleAuthContext === 'signup') {
    const cb = document.getElementById('signupTerms');
    const err = document.getElementById('signupTermsError');
    if (!cb || !cb.checked) {
      if (err) err.classList.remove('d-none');
      return;
    }
    if (err) err.classList.add('d-none');
  }

setGoogleButtonLoading(window._googleAuthContext, true);

//console.log("‚úÖ Clicking Google button, client =", !!window._googleCodeClient);

if (!window._googleCodeClient) {
  if (typeof window.tryInitGoogle === "function") window.tryInitGoogle();

  setTimeout(() => {
    if (!window._googleCodeClient) {
      setGoogleButtonLoading(window._googleAuthContext, false);
      alert("Google still loading. Please try again in 2 seconds.");
      return;
    }
    window._googleCodeClient.requestCode();
  }, 250);

  return;
}

// IMPORTANT: call directly (no setTimeout, no await)
window._googleCodeClient.requestCode();
}



  document.addEventListener('DOMContentLoaded', function () {
    const authForm = document.getElementById('authForm');
    const isAuthenticated = authForm.dataset.isAuthenticated === 'true';
    const profileNavItem = document.getElementById('profileNavItem');
    const bookNowItem = document.getElementById('bookNowItem');
    const logoutBtn = document.getElementById('logoutBtn');
    const signupForm = document.getElementById('signupForm');
    const signupOtpSection = document.getElementById('signupOtpSection');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendEmailOtpBtn = document.getElementById('resendEmailOtpBtn');
    const backToSignupBtn = document.getElementById('backToSignupBtn');
    const otpStatus = document.getElementById('otpStatus');
    const signupStatus = document.getElementById('signupStatus');
    const otpHint = document.getElementById('otpHint');

    // THEME: load stored or default
    const storedTheme = localStorage.getItem(THEME_KEY) || "monochrome";
    applyTheme(storedTheme);
    document.querySelectorAll(".theme-dot").forEach(dot => {
      dot.addEventListener("click", () => {
        const theme = dot.dataset.themeOption;
        applyTheme(theme);
        localStorage.setItem(THEME_KEY, theme);
      });
    });

    // Button sections
    const signupButtons = document.getElementById('signupButtons');
    const loginButtons = document.getElementById('loginButtons');
    const otpButtons = document.getElementById('otpButtons');

    // Tab switching functionality
    const signupTab = document.getElementById('signup-tab');
    const loginTab = document.getElementById('login-tab');

    if (signupTab && loginTab) {
      signupTab.addEventListener('click', function() {
        if (signupButtons) signupButtons.classList.remove('d-none');
        if (loginButtons) loginButtons.classList.add('d-none');
        if (otpButtons) otpButtons.classList.add('d-none');
      });

      loginTab.addEventListener('click', function() {
        if (signupButtons) signupButtons.classList.add('d-none');
        if (loginButtons) loginButtons.classList.remove('d-none');
        if (otpButtons) otpButtons.classList.add('d-none');
      });
    }


    window.simulateLogin = function() {
      if (bookNowItem) bookNowItem.classList.add('d-none');
      if (profileNavItem) profileNavItem.classList.remove('d-none');
    }

    if (isAuthenticated) {
      if (profileNavItem) profileNavItem.classList.remove('d-none');
      if (bookNowItem) bookNowItem.classList.add('d-none');
    } else {
      if (profileNavItem) profileNavItem.classList.add('d-none');
      if (bookNowItem) bookNowItem.classList.remove('d-none');
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('{% trans "Are you sure you want to log out?" %}')) {
          fetch("/customers/api/logout/", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
          })
          .then(response => {
            if (response.ok) {
              profileNavItem.classList.add('d-none');
              bookNowItem.classList.remove('d-none');
              window.location.href = "{% url 'home' %}";
            } else {
              alert("{% trans 'Logout failed.' %}");
            }
          })
          .catch(error => console.error("Error logging out:", error));
        }
      });
    }

    document.querySelectorAll('.toggleAuthForm').forEach(button => {
      button.addEventListener('click', function () {
        if (isAuthenticated) {
          window.location.href = "/bookings/book";
        } else {
          authForm.classList.remove('d-none');
        }
      });
    });

    // ====== SIGNUP SUBMIT ======
    if (signupForm) {
      signupForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const signupTermsCheckbox = document.getElementById('signupTerms');
        const signupTermsError = document.getElementById('signupTermsError');

        const signupData = {
          first_name: document.getElementById('signupFirstName').value.trim(),
          last_name: document.getElementById('signupLastName').value.trim(),
          email_id: document.getElementById('signupEmail').value.trim(),
          password: document.getElementById('signupPassword').value,
          confirm_password: document.getElementById('signupConfirmPassword').value,
          terms_accepted: signupTermsCheckbox ? signupTermsCheckbox.checked : false,
        };

        if (!signupData.first_name || !signupData.last_name || !signupData.email_id) {
          signupStatus.textContent = "{% trans 'Please fill all required fields.' %}";
          return;
        }
        if (signupData.password !== signupData.confirm_password) {
          signupStatus.textContent = "{% trans 'Passwords do not match.' %}";
          return;
        }
        // ‚úÖ NEW: check Terms & Conditions BEFORE enabling loader
        if (!signupTermsCheckbox || !signupTermsCheckbox.checked) {
          if (signupTermsError) {
            signupTermsError.classList.remove('d-none');
          }
          signupStatus.textContent = "{% trans 'You must accept the terms and privacy policy to sign up.' %}";
          return;  // nothing started yet, so no stuck loader
        } else if (signupTermsError) {
          signupTermsError.classList.add('d-none');
        }
        const submitBtn = signupButtons.querySelector('.btn-auth');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {% trans "Loading..." %}`;
        signupStatus.textContent = "";

        try {
          signupData.terms_accepted = true;
          const signupResp = await fetch('/customers/api/signup/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify(signupData)
          });
          const signupJson = await signupResp.json();

          if (!signupResp.ok || signupJson.status === 'error') {
            const errorMsg =
              signupJson?.message ||
              signupJson?.error ||
              signupJson?.detail ||
              "{% trans 'Something went wrong. Please try again.' %}";

            if (signupStatus) {
              signupStatus.className = "alert alert-danger";   // üî¥ red error box
              signupStatus.textContent = errorMsg;
              signupStatus.classList.remove('d-none');
              signupStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
          }

          if (signupJson.success === false) {
            const errorMsg =
              signupJson?.message ||
              "{% trans 'Signup failed.' %}";

            if (signupStatus) {
              signupStatus.className = "alert alert-danger";   // üî¥ red error box
              signupStatus.textContent = errorMsg;
              signupStatus.classList.remove('d-none');
              signupStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
          }


          state.signupData = signupData;

          signupStatus.textContent = "{% trans 'Sending OTP to your email‚Ä¶' %}";
          const otpResponse = await fetch(`${scriptUrl}?email=${encodeURIComponent(signupData.email_id)}`);
          const otpResult = await otpResponse.json();
          const otpButtons = document.getElementById('otpButtons');

          if (!otpResult.success) {
            signupStatus.textContent = "{% trans 'Failed to send email OTP.' %}";
            return;
          }

          signupForm.classList.add('d-none');
          signupOtpSection.classList.remove('d-none');
          signupButtons.classList.add('d-none');
          otpStatus.innerHTML = `<span class="otp-success">{% trans 'Email OTP sent. Please check your inbox.' %}</span>`;
          otpHint.textContent = `{% trans 'We sent a verification code to' %} ${signupData.email_id}.`;
        } catch (err) {
          console.error(err);
          signupStatus.textContent = "{% trans 'Something went wrong. Please try again.' %}";
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
    }

    // ====== BACK TO SIGNUP ======
    if (backToSignupBtn) {
      backToSignupBtn.addEventListener('click', function () {
        document.getElementById('emailOtp').value = '';
        document.getElementById('emailOtp').classList.remove('is-invalid', 'is-valid');
        document.getElementById('emailOtpError').classList.add('d-none');
        otpStatus.textContent = '';
        document.getElementById('signupForm').classList.remove('d-none');
        document.getElementById('signupOtpSection').classList.add('d-none');
  if (signupButtons) signupButtons.classList.remove('d-none');
  if (otpButtons) otpButtons.classList.add('d-none');
      });
    }

    function showFieldError(inputEl, errorEl, show) {
      if (show) {
        inputEl.classList.add('is-invalid');
        errorEl.classList.remove('d-none');
      } else {
        inputEl.classList.remove('is-invalid');
        errorEl.classList.add('d-none');
        inputEl.classList.add('is-valid');
      }
    }

    // ====== VERIFY OTP ======
    if (verifyOtpBtn) {
      verifyOtpBtn.addEventListener('click', async function () {
        const emailOtpInput = document.getElementById('emailOtp');
        const emailErr = document.getElementById('emailOtpError');

        let valid = true;
        if (!emailOtpInput.value.trim()) { 
          showFieldError(emailOtpInput, emailErr, true); 
          valid = false; 
        } else { 
          showFieldError(emailOtpInput, emailErr, false); 
        }
        
        if (!valid) {
          otpStatus.innerHTML = `<span class="otp-error">{% trans "Please enter the email OTP." %}</span>`;
          return;
        }

        const original = verifyOtpBtn.innerHTML;
        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {% trans "Verifying..." %}`;
        otpStatus.textContent = "";

        try {
          const response = await fetch("/customers/api/verify-otp/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify({
              email_id: state.signupData.email_id,
              email_otp: emailOtpInput.value.trim()
            })
          });
          const result = await response.json();

          if (!result.success) {
            otpStatus.innerHTML = `<span class="otp-error">{% trans "Invalid OTP. Please try again." %}</span>`;
            return;
          }

          otpStatus.innerHTML = `<span class="otp-success">{% trans "Verification successful! Signing you in‚Ä¶" %}</span>`;
          document.getElementById('authForm').classList.add('d-none');
          window.location.href = "/bookings/book";
        } catch (err) {
          console.error(err);
          otpStatus.innerHTML = `<span class="otp-error">{% trans "Verification failed. Please try again." %}</span>`;
        } finally {
          verifyOtpBtn.disabled = false;
          verifyOtpBtn.innerHTML = original;
        }
      });
    }

    // ====== RESEND EMAIL OTP ======
    if (resendEmailOtpBtn) {
      resendEmailOtpBtn.addEventListener('click', async function () {
        if (!state.signupData?.email_id) return;
        resendEmailOtpBtn.disabled = true;
        const original = resendEmailOtpBtn.innerText;
        resendEmailOtpBtn.innerHTML = `{% trans "Sending‚Ä¶" %}`;

        try {
          const otpResponse = await fetch(`${scriptUrl}?email=${encodeURIComponent(state.signupData.email_id)}`);
          const otpResult = await otpResponse.json();
          if (otpResult.success) {
            otpStatus.innerHTML = `<span class="otp-success">{% trans "Email OTP resent." %}</span>`;
          } else {
            otpStatus.innerHTML = `<span class="otp-error">{% trans "Failed to resend email OTP." %}</span>`;
          }
        } catch (e) {
          otpStatus.innerHTML = `<span class="otp-error">{% trans "Network error. Please try again." %}</span>`;
        } finally {
          resendEmailOtpBtn.disabled = false;
          resendEmailOtpBtn.innerText = original;
        }
      });
    }

    // ====== LOGIN ======
    const loginFormEl = document.getElementById('loginForm');
    if (loginFormEl) {
      loginFormEl.addEventListener('submit', function (e) {
        e.preventDefault();
        const loginButton = loginButtons.querySelector('.btn-auth');
        const originalButtonText = loginButton.innerHTML;
        const loginMessageDiv = document.getElementById('loginMessage');
        loginMessageDiv.innerText = '';
        loginButton.disabled = true;
        loginButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {% trans "Loading..." %}`;

        const data = {
          email_id: document.getElementById('loginEmail').value,
          password: document.getElementById('loginPassword').value
        };
        fetch('/customers/api/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
          credentials: 'include',
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            window.simulateLogin && window.simulateLogin();
            document.getElementById('authForm').classList.add('d-none');
            window.location.href = "/bookings/book";
          } else {
            loginMessageDiv.style.backgroundColor = '#ffe6e6';
            loginMessageDiv.style.color = '#b00020';
            loginMessageDiv.style.padding = '0.5rem';
            loginMessageDiv.style.borderRadius = '0.25rem';
            loginMessageDiv.innerText = result.message;
            loginButton.disabled = false;
            loginButton.innerHTML = originalButtonText;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert("{% trans 'An error occurred during login.' %}");
          loginButton.disabled = false;
          loginButton.innerHTML = originalButtonText;
        });
      });
    }

    // highlight current nav link
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-link-toggle').forEach(link => {
      if (link.getAttribute('href') === currentPath) link.classList.add('active');
      else link.classList.remove('active');
    });
  });
  // ===== Reset Password inside login card =====
(function() {
    const forgotLink = document.getElementById('forgotPasswordLink');
    const loginFormEl = document.getElementById('loginForm');
    const resetSection = document.getElementById('resetPasswordSection');
    if (!forgotLink || !loginFormEl || !resetSection) return;

    const loginButtonsContainer = document.getElementById('loginButtons');
    const loginMessage = document.getElementById('loginMessage');

    const rpStepText = document.getElementById('rpStepText');
    const rpBackBtn = document.getElementById('rpBackBtn');
    const rpNextBtn = document.getElementById('rpNextBtn');
    const rpMsgDiv = document.getElementById('resetPasswordMessage');
    const backToLoginLink = document.getElementById('backToLoginFromReset');

    const emailInput = document.getElementById('forgotEmail');
    const otpInput = document.getElementById('forgotOtp');
    const newPwdInput = document.getElementById('forgotNewPassword');
    const confirmPwdInput = document.getElementById('forgotConfirmPassword');
    const stepContainers = resetSection.querySelectorAll('.rp-step');

    let currentStep = 1;
    let isLoading = false;

    function updateStepUI() {
      stepContainers.forEach(stepEl => {
        const step = parseInt(stepEl.getAttribute('data-step'));
        if (step === currentStep) {
          stepEl.classList.remove('d-none');
        } else {
          stepEl.classList.add('d-none');
        }
      });

      if (currentStep === 1) {
        rpStepText.innerText = 'Step 1/3 ‚Äì Enter email';
        rpBackBtn.classList.add('d-none');
        if (!isLoading) rpNextBtn.innerText = 'Send OTP';
      } else if (currentStep === 2) {
        rpStepText.innerText = 'Step 2/3 ‚Äì Enter OTP';
        rpBackBtn.classList.remove('d-none');
        if (!isLoading) rpNextBtn.innerText = 'Next';
      } else if (currentStep === 3) {
        rpStepText.innerText = 'Step 3/3 ‚Äì Create new password';
        rpBackBtn.classList.remove('d-none');
        if (!isLoading) rpNextBtn.innerText = 'Change password';
      }
    }

    function setLoading(loading, labelWhileLoading) {
      isLoading = loading;
      if (loading) {
        rpNextBtn.disabled = true;
        rpBackBtn.disabled = true;
        rpNextBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>' +
          labelWhileLoading;
      } else {
        rpNextBtn.disabled = false;
        rpBackBtn.disabled = false;
        rpNextBtn.innerHTML = ''; // will be set by updateStepUI
        updateStepUI();
      }
    }

    function resetForgotFlow() {
      currentStep = 1;
      isLoading = false;
      rpMsgDiv.innerText = '';
      rpMsgDiv.style.color = '';
      emailInput.value = '';
      otpInput.value = '';
      newPwdInput.value = '';
      confirmPwdInput.value = '';

      // Pre-fill email from login form if present
      const loginEmail = document.getElementById('loginEmail');
      if (loginEmail && loginEmail.value) {
        emailInput.value = loginEmail.value;
      }

      updateStepUI();
    }

    function enterResetMode() {
      resetForgotFlow();
      loginFormEl.classList.add('d-none');
      if (loginButtonsContainer) loginButtonsContainer.classList.add('d-none');
      resetSection.classList.remove('d-none');
    }

    function backToLogin() {
      resetForgotFlow();
      resetSection.classList.add('d-none');
      loginFormEl.classList.remove('d-none');
      if (loginButtonsContainer) loginButtonsContainer.classList.remove('d-none');
    }

    function showLoginSuccess(msg) {
      if (!loginMessage) return;
      loginMessage.style.color = '#006400';
      loginMessage.innerText = msg;
    }

    // Open reset flow when clicking "Forgot password?"
    forgotLink.addEventListener('click', function(e) {
      e.preventDefault();
      enterResetMode();
    });

    // Top "Back to login" link
    if (backToLoginLink) {
      backToLoginLink.addEventListener('click', function() {
        backToLogin();
      });
    }

    // Small "Back" button inside the wizard
    rpBackBtn.addEventListener('click', function() {
      if (isLoading) return;
      if (currentStep > 1) {
        currentStep -= 1;
        rpMsgDiv.innerText = '';
        updateStepUI();
      }
    });

    // Main step button
    rpNextBtn.addEventListener('click', function () {
      if (isLoading) return;
      rpMsgDiv.innerText = '';

      // STEP 1: send OTP via Google Apps Script
      if (currentStep === 1) {
        if (!emailInput.value) {
          rpMsgDiv.style.color = '#b00020';
          rpMsgDiv.innerText = 'Please enter your email.';
          return;
        }

        rpMsgDiv.style.color = '#666';
        rpMsgDiv.innerText = 'Sending OTP to your email‚Ä¶';
        setLoading(true, 'Sending‚Ä¶');

        fetch(`${scriptUrl}?email=${encodeURIComponent(emailInput.value)}`)
          .then(res => res.json())
          .then(otpResult => {
            if (!otpResult.success) {
              rpMsgDiv.style.color = '#b00020';
              rpMsgDiv.innerText = 'Failed to send email OTP.';
              return;
            }

            rpMsgDiv.style.color = '#006400';
            rpMsgDiv.innerText = 'OTP sent to your email.';
            currentStep = 2;
          })
          .catch(() => {
            rpMsgDiv.style.color = '#b00020';
            rpMsgDiv.innerText = 'Something went wrong. Please try again.';
          })
          .finally(() => {
            setLoading(false);
          });

      // STEP 2: verify OTP with existing /customers/api/verify-otp/
      } else if (currentStep === 2) {
        if (!otpInput.value) {
          rpMsgDiv.style.color = '#b00020';
          rpMsgDiv.innerText = 'Please enter the OTP code.';
          return;
        }

        const payload = {
          email_id: emailInput.value,
          email_otp: otpInput.value
        };

        rpMsgDiv.style.color = '#666';
        rpMsgDiv.innerText = 'Verifying OTP‚Ä¶';
        setLoading(true, 'Verifying‚Ä¶');

        fetch('/customers/api/verify-otp/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'include',
          body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            rpMsgDiv.style.color = '#006400';
            rpMsgDiv.innerText = result.message || 'OTP verification successful.';
            currentStep = 3;
          } else {
            rpMsgDiv.style.color = '#b00020';
            rpMsgDiv.innerText = result.message || 'Invalid OTP. Please try again.';
          }
        })
        .catch(() => {
          rpMsgDiv.style.color = '#b00020';
          rpMsgDiv.innerText = 'Something went wrong. Please try again.';
        })
        .finally(() => {
          setLoading(false);
        });

      // STEP 3: change password (OTP already verified)
      } else if (currentStep === 3) {
        if (!newPwdInput.value || !confirmPwdInput.value) {
          rpMsgDiv.style.color = '#b00020';
          rpMsgDiv.innerText = 'Please enter and confirm your new password.';
          return;
        }
        if (newPwdInput.value !== confirmPwdInput.value) {
          rpMsgDiv.style.color = '#b00020';
          rpMsgDiv.innerText = 'Passwords do not match.';
          return;
        }

        const payload = {
          email_id: emailInput.value,
          password: newPwdInput.value,
          confirm_password: confirmPwdInput.value
        };

        rpMsgDiv.style.color = '#666';
        rpMsgDiv.innerText = 'Changing your password‚Ä¶';
        setLoading(true, 'Saving‚Ä¶');

        fetch('/customers/api/reset-password/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'include',
          body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            rpMsgDiv.style.color = '#006400';
            rpMsgDiv.innerText = result.message || 'Password changed successfully. Redirecting to login‚Ä¶';

            // Immediately go back to login form with a success message
            backToLogin();
            showLoginSuccess('Password changed successfully. Please log in with your new password.');
          } else {
            rpMsgDiv.style.color = '#b00020';
            rpMsgDiv.innerText = result.message || 'Could not reset password.';
          }
        })
        .catch(() => {
          rpMsgDiv.style.color = '#b00020';
          rpMsgDiv.innerText = 'Something went wrong. Please try again.';
        })
        .finally(() => {
          setLoading(false);
        });
      }
    });

    // Initial UI
    updateStepUI();
  })();
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const params = new URLSearchParams(window.location.search);
    if (params.get("openAuth") === "1") {
      const authForm = document.getElementById("authForm");
      if (authForm) authForm.classList.remove("d-none");
    }
  });
</script>

{% endblock %}
