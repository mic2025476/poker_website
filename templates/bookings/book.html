{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% block content %}
<!-- Include external JS files for new booking and edit booking logic -->
<script src="{% static 'js/booking_form.js' %}?v={{ timestamp }}"></script>
<script src="{% static 'js/booking_edit_form.js' %}"></script>

<script id="pricing-config" type="application/json">
{
  "gross_day_rental": "{{ pricing_cfg.gross_day_rental }}",
  "gross_dealer": "{{ pricing_cfg.gross_dealer }}",
  "gross_service": "{{ pricing_cfg.gross_service }}",
  "gross_drinks_flatrate": "{{ pricing_cfg.gross_drinks_flatrate }}",
  "vat_rate": "{{ pricing_cfg.vat_rate }}",
  "deposit_amount": "{{ pricing_cfg.deposit_amount }}"
}
</script>

<style>
  :root {
    /* Brand BLUE palette (matches home page "blue-table" theme) */
    --theme-primary: #2457b6;                 /* main blue */
    --theme-primary-hover: #3b6fd4;           /* hover blue */
    --theme-primary-light: rgba(36, 87, 182, 0.18);

    /* Backwards-compatible aliases (so existing var(--theme-red*) still work) */
    --theme-red: var(--theme-primary);
    --theme-red-hover: var(--theme-primary-hover);
    --theme-red-light: var(--theme-primary-light);

    /* Offset for fixed bottom nav + booking buttons */
    --bottom-nav-height: 3.25rem;
  }

  /* Mobile-first responsive design */
  .main-container {
    padding-top: clamp(4.5rem, 7vh, 6rem);
    padding-left: var(--container-gutter);
    padding-right: var(--container-gutter);
    padding-bottom: calc(var(--bottom-nav-height) + 1.5rem);
    margin: 0 auto;
    min-height: 100vh;
    max-width: var(--container-max-width);
    display: flex;
    flex-direction: column;
    overflow: visible;
  }

  @media (min-width: 1920px) {
    .main-container {
      max-width: var(--container-max-width-wide);
    }
  }
  
  /* Checkbox styling - using flexbox for better alignment */
.booking-page .form-check {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin-bottom: 0.75rem;
  padding: 0.55rem 0.9rem;
  border-radius: 0.5rem;
  background: #f8f9fb;
  border: 1px solid #e5e7eb;
}

.booking-page .form-check-input {
  flex-shrink: 0;
  width: 16px;
  height: 16px;
  margin: 0;
  border-radius: 4px;
  border: 1.5px solid #94a3b8;
  cursor: pointer;
}

.booking-page .form-check-input:checked {
  background-color: var(--theme-primary);
  border-color: var(--theme-primary);
}

.booking-page .form-check-input:focus {
  border-color: var(--theme-primary);
  box-shadow: 0 0 0 3px var(--theme-primary-light);
  outline: none;
}

.booking-page .form-check-label {
  margin: 0;
  line-height: 1.4;
  cursor: pointer;
  font-size: 0.9rem;
  color: #111827;
}

  
  /* Enhanced form group spacing */
  .mb-3 {
    margin-bottom: 1.1rem !important;
  }

  
  /* Form inputs inside booking page ‚Äì primary styling */
.booking-page .form-control,
.booking-page .form-select {
  margin-bottom: 0.75rem; /* was big var(--space-4) */
  padding: clamp(0.55rem, 0.9vw, 0.7rem) clamp(0.9rem, 1.2vw, 1.1rem);
  border-radius: 0.5rem;
  border: 2px solid var(--gray-200);
  font-size: var(--font-size-base);
  transition: border-color 0.2s, box-shadow 0.2s;
  min-height: 44px;
}


  .booking-page .form-control:focus,
  .booking-page .form-select:focus {
    border-color: var(--theme-primary);
    box-shadow: 0 0 0 3px var(--theme-primary-light);
    outline: none;
    background-color: #ffffff;
  }

  @media (min-width: 1280px) {
    .booking-page .form-control,
    .booking-page .form-select {
      padding: 0.75rem 1rem;
    }
  }

  /* Ensure global form controls don't shrink the height */
  .form-control,
  .form-select {
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 0.55rem 0.75rem;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    background-color: #f8f9fa;
    min-height: 2.5rem;
    height: auto;
    line-height: 1.35;
  }
  
  .form-control:focus,
  .form-select:focus {
    border-color: var(--theme-primary);
    box-shadow: 0 0 0 0.15rem var(--theme-primary-light);
    background-color: #ffffff;
    transform: translateY(-1px);
  }

  /* Better spacing for form rows */
  .row .col-md-6 {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  /* Enhanced button spacing */
  .d-flex.justify-content-between {
    padding: 1rem 0;
    margin-top: 1.5rem;
  }
  
  /* Mobile responsive adjustments */
  @media (max-width: 768px) {
    .main-container {
      padding-left: 1.25rem;
      padding-right: 1.25rem;
    }
    
    .tab-content {
      max-width: 100%;
      padding: 0 0.5rem;
    }
    
  }

  .tab-content {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 150px);
    height: auto;
    padding: 0;
  }

  @media (min-width: 1280px) {
    .tab-content {
      padding: 0 var(--space-6);
    }
  }

  @media (max-width: 768px) {
    .tab-content {
      padding: 0 var(--space-4);
    }
  }

  /* Header section (no sticky to prevent clipping under main navbar) */
  .booking-header {
    position: relative;
    top: auto;
    z-index: 1;
    background: #ffffff;
    border-bottom: 1px solid #e9ecef;
    padding: 0.85rem 1.25rem 0.6rem;
    flex-shrink: 0;
  }

  /* Step indicators ‚Äì kept static for clean layout */
  .booking-steps {
    position: relative;
    top: auto;
    z-index: 1;
    background: #ffffff;
    padding: 0.5rem 1.25rem 0.75rem;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
  }

  /* Scrollable content area (use page scroll, not inner scroll) */
.booking-content {
  flex: 1;
  overflow-y: auto;
  padding: 0.6rem 1.5rem calc(var(--bottom-nav-height) + 7rem);
  max-height: none;
}


.booking-content h5,
.booking-content h6 {
  margin-top: 0.25rem;
  margin-bottom: 0.6rem;
}


  /* Sticky navigation buttons */
  .booking-nav-buttons {
    position: fixed;
    bottom: calc(var(--bottom-nav-height) + 0.75rem); /* just above bottom nav */
    left: 0;
    right: 0;
    background: #ffffff;
    border-top: 1px solid #e9ecef;
    padding: 0.75rem 1rem;
    z-index: 8;
    box-shadow: 0 -4px 14px rgba(0,0,0,0.12);
  }

  /* Modern card styling */
  .booking-card {
    background: #ffffff;
    border: none;
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    margin-top: 0.75rem;
  }

  /* Professional bottom navigation */
  .bottom-nav {
    background: linear-gradient(135deg, #0b1224 0%, #141f3d 100%);
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    padding: 0.45rem 0;
  }

  .nav-tab {
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    transition: all 0.3s ease;
    padding: 0.7rem 0.45rem;
    border-radius: 1rem;
    margin: 0 0.25rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 0.8rem;
    font-weight: 500;
    position: relative;
    overflow: hidden;
  }

  .nav-tab i {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
    transition: all 0.3s ease;
  }

  .nav-tab:hover {
    color: rgba(255, 255, 255, 0.95);
    background: rgba(255, 255, 255, 0.06);
    transform: translateY(-2px);
  }

  .nav-tab.active {
    color: #ffffff;
    background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
    box-shadow: 0 4px 15px var(--theme-primary-light);
    transform: translateY(-3px);
  }

  .nav-tab.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.18) 0%, transparent 100%);
    pointer-events: none;
  }

  /* Mobile-optimized hero section */
  #hero {
    min-height: auto;
    padding: 1rem 0;
    background-attachment: scroll;
  }

  /* Step indicator for forms */
  .step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 0.75rem;
  }

  .step {
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 0.3rem;
    font-weight: 600;
    font-size: 0.7rem;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .step.completed {
    background: var(--theme-primary);
    color: #ffffff;
    border-color: transparent;
  }

  .step.active {
    background: #ffffff;
    color: var(--theme-primary);
    border-color: var(--theme-primary);
    box-shadow: 0 0 0 3px var(--theme-primary-light);
    transform: scale(1.1);
  }

  .step.pending {
    background: #e9ecef;
    color: #6c757d;
  }

  /* Modern buttons */
  .btn-primary-custom {
    background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
    border: none;
    border-radius: 999px;
    padding: 0.65rem 1.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    transition: all 0.25s ease;
    box-shadow: 0 3px 10px var(--theme-primary-light);
    font-size: 0.85rem;
    height: 2.6rem;
  }

  .btn-primary-custom:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px var(--theme-primary-light);
  }

  .btn-secondary-custom {
    background: #6c757d;
    border: none;
    border-radius: 999px;
    padding: 0.65rem 1.6rem;
    font-weight: 600;
    color: #ffffff;
    transition: all 0.25s ease;
    font-size: 0.85rem;
    height: 2.6rem;
  }

  .btn-secondary-custom:hover {
    background: #5a6268;
    transform: translateY(-1px);
  }

  /* Pricing display */
.pricing-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9efff 100%);
  border-radius: 0.75rem;
  padding: 1rem;
  margin: 0.75rem 0 8rem;
  border-left: 3px solid var(--theme-primary);
  color: #111827; /* make all text inside the card dark */
}


  .price-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.06);
    font-size: 0.85rem;
  }

  .price-item:last-child {
    border-bottom: none;
  }
/* Highlight "Whole Day Rental" instead of "Total Amount" */
#baseRentalCost {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--theme-primary);
}

  /* Mobile responsive tweaks */
  @media (max-width: 576px) {
    .booking-header {
      padding: 0.6rem 0.9rem 0.4rem;
    }

    .booking-steps {
      padding: 0.35rem 0.9rem 0.5rem;
    }

    .booking-content {
      padding: 0.85rem 0.85rem 5.5rem;
    }

    .booking-nav-buttons {
      padding: 0.55rem 0.9rem;
    }

    .nav-tab {
      font-size: 0.65rem;
      padding: 0.45rem 0.2rem;
    }

    .nav-tab i {
      font-size: 1rem;
      margin-bottom: 0.15rem;
    }

    .booking-card {
      margin-bottom: 0.75rem;
      border-radius: 0.85rem;
    }

    .form-control,
    .form-select {
      font-size: 16px; /* Prevent iOS zoom */
      padding: 0.5rem 0.75rem;
      min-height: 2.4rem;
    }

    .btn-primary-custom,
    .btn-secondary-custom {
      font-size: 0.8rem;
      padding: 0.5rem 1.2rem;
      height: 2.4rem;
    }

    .pricing-card {
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 0.6rem;
    }

    .price-item {
      padding: 0.3rem 0;
      font-size: 0.8rem;
    }

    .price-item:last-child {
      font-size: 0.85rem;
    }

    .step {
      width: 1.25rem;
      height: 1.25rem;
      margin: 0 0.2rem;
      font-size: 0.65rem;
    }

    .step-indicator {
      margin-bottom: 0.4rem;
    }

    .booking-card .card-body {
      padding: 1rem !important;
    }

    .text-center h6 {
      font-size: 0.98rem;
    }

    .text-center p {
      font-size: 0.8rem !important;
    }

    .tab-content {
      max-width: 100%;
    }
  }

  /* Animation classes */
  .fade-in {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Enhanced Modern Booking Card Styles */
  .booking-card-modern {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    margin-bottom: 12px;
    border: 1px solid #f1f3f5;
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
  }

  .booking-card-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
  }

  .booking-card-modern:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
  }

  .booking-card-header {
    padding: 12px 16px 10px;
    background: linear-gradient(135deg, #f5f7fb 0%, #f8f9fa 100%);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 1px solid #e9ecef;
    position: relative;
  }

  .booking-date-info .booking-date {
    font-size: 0.85rem;
    font-weight: 700;
    color: #1a1d21;
    margin-bottom: 2px;
    letter-spacing: -0.02em;
  }

  .booking-date-info .booking-time {
    font-size: 0.75rem;
    color: #6c757d;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .booking-date-info .booking-time::before {
    content: 'üïê';
    font-size: 0.9rem;
  }

  .booking-status {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 16px;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .status-active {
    background: linear-gradient(135deg, #20c997 0%, #198754 100%);
    color: #ffffff;
  }

  /* Neutral cancelled status */
  .status-cancelled {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: #ffffff;
  }

  .booking-card-body {
    padding: 14px 16px;
  }

  .booking-details-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 12px;
  }

  .booking-detail {
    text-align: center;
    background: #f8f9fa;
    padding: 12px 8px;
    border-radius: 12px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .booking-detail:hover {
    border-color: var(--theme-primary);
    background: var(--theme-primary-light);
    transform: translateY(-2px);
  }

  .detail-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-size: 0.65rem;
    color: #495057;
    margin-bottom: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .detail-label i {
    font-size: 0.9rem;
    color: var(--theme-primary);
    padding: 4px;
    background: var(--theme-primary-light);
    border-radius: 50%;
  }

  .detail-value {
    font-size: 0.9rem;
    font-weight: 700;
    color: #1a1d21;
    letter-spacing: -0.02em;
  }

  .booking-drinks {
    padding: 12px 0 0;
    border-top: 1px solid #e9ecef;
  }

  .drinks-label {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    color: #495057;
    margin-bottom: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .drinks-label i {
    font-size: 1rem;
    color: var(--theme-primary);
    padding: 4px;
    background: var(--theme-primary-light);
    border-radius: 50%;
  }

  .drinks-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .drink-tag {
    background: linear-gradient(
      135deg,
      var(--theme-primary-light) 0%,
      rgba(36, 87, 182, 0.06) 100%
    );
    color: var(--theme-primary-hover);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 700;
    border: 1px solid var(--theme-primary-light);
    transition: all 0.3s ease;
  }

  .drink-tag:hover {
    background: var(--theme-primary);
    color: #ffffff;
    transform: translateY(-1px);
  }

  .booking-card-actions {
    padding: 16px;
    background: linear-gradient(135deg, #fafbfc 0%, #f5f7fb 100%);
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 70px;
  }

  .btn-action {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    border: none;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: relative;
    overflow: hidden;
    min-height: 44px;
    max-width: 180px;
    margin: 0 auto;
  }

  .btn-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s ease;
  }

  .btn-action:hover::before {
    left: 100%;
  }

  /* Neutral cancel button */
  .btn-cancel {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: #ffffff;
    box-shadow: 0 4px 16px rgba(73, 80, 87, 0.3);
  }

  .btn-cancel:hover:not(:disabled) {
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(73, 80, 87, 0.4);
  }

  .btn-cancel:disabled {
    background: #6c757d;
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-cancel:disabled::before {
    display: none;
  }

  /* Cancelled booking button */
  .btn-cancelled {
    background: #6c757d;
    color: #ffffff;
    box-shadow: 0 2px 8px rgba(108, 117, 125, 0.2);
    opacity: 0.8;
    cursor: not-allowed;
  }

  .btn-cancelled:hover {
    background: #6c757d;
    transform: none;
    box-shadow: 0 2px 8px rgba(108, 117, 125, 0.2);
  }

  .btn-cancelled::before {
    display: none;
  }

  /* Late cancellation button using brand blue */
  .btn-cancel-warning {
    background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
    color: #ffffff;
    box-shadow: 0 4px 16px var(--theme-primary-light);
  }

  .btn-cancel-warning:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--theme-primary-hover) 0%, var(--theme-primary) 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px var(--theme-primary-light);
  }

  /* Responsive adjustments */
  @media (max-width: 576px) {
    .booking-details-row {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .booking-card-header {
      flex-direction: column;
      gap: 12px;
    }
    
    .booking-card-actions {
      flex-direction: column;
      padding: 12px;
    }

    .btn-action {
      max-width: 160px;
      font-size: 0.75rem;
      padding: 8px 12px;
    }
  }

  /* ===== MODERN PROFILE STYLES ===== */
  .profile-modern-container {
    padding: 1rem;
    max-width: 100%;
    margin: 0 auto;
  }

  .profile-header-card {
    background: #ffffff;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    position: relative;
  }

  .profile-background-gradient {
    height: 120px;
    background: linear-gradient(
      135deg,
      var(--theme-primary) 0%,
      var(--theme-primary-hover) 50%,
      #1e88e5 100%
    );
    position: relative;
  }

  .profile-background-gradient::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="poker" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><text x="10" y="15" text-anchor="middle" fill="rgba(255,255,255,0.1)" font-size="12">‚ô†‚ô•‚ô£‚ô¶</text></pattern></defs><rect width="100" height="100" fill="url(%23poker)"/></svg>');
    opacity: 0.3;
  }

  .profile-content {
    padding: 1.5rem;
    margin-top: -40px;
    position: relative;
    z-index: 2;
  }

  .profile-avatar-section {
    display: flex;
    align-items: flex-end;
    gap: 1rem;
  }

  .profile-avatar {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border: 4px solid #ffffff;
  }

  .profile-avatar i {
    font-size: 3.5rem;
    color: var(--theme-primary);
  }

  .verification-indicator {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: #28a745;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #ffffff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .verification-indicator i {
    font-size: 0.7rem;
    color: #ffffff;
  }

  .profile-title {
    flex: 1;
    margin-bottom: 0.5rem;
  }

  .profile-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0;
    letter-spacing: -0.02em;
  }

  .profile-subtitle {
    color: #6c757d;
    margin: 0;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .profile-info-card {
    background: #ffffff;
    border-radius: 16px;
    margin-bottom: 1rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    border: 1px solid #f1f3f5;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .profile-info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }

  .profile-card-header {
    background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .profile-card-header i {
    font-size: 1.1rem;
    color: var(--theme-primary);
    width: 20px;
    text-align: center;
  }

  .profile-card-header h6 {
    margin: 0;
    font-weight: 600;
    color: #1a1a1a;
    font-size: 0.95rem;
  }

  .profile-card-body {
    padding: 1.25rem;
  }

  .info-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .info-row:last-child {
    margin-bottom: 0;
  }

  .info-item {
    flex: 1;
  }

  .info-item.full-width {
    flex: unset;
    width: 100%;
  }

  .info-item label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .info-item span {
    font-size: 0.95rem;
    font-weight: 500;
    color: #1a1a1a;
    display: block;
  }

  .info-with-badge {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .verified-badge {
    background: #28a745;
    color: #ffffff;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .verified-badge.unverified {
    background: #ffc107;
    color: #1a1a1a;
  }

  .mobile-input-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    align-items: stretch;
  }

  .input-with-icon {
    flex: 1;
    position: relative;
  }

  .input-with-icon i {
    position: absolute;
    left: 1.2rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--theme-primary);
    z-index: 2;
    font-size: 1.1rem;
  }

  .input-with-icon input {
    width: 100%;
    padding: 1rem 1.2rem 1rem 3.5rem;
    border: 2px solid #e9ecef;
    border-radius: 16px;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.3s ease;
    background: #fafbfc;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .input-with-icon input:focus {
    outline: none;
    border-color: var(--theme-primary);
    background: #ffffff;
    box-shadow: 0 0 0 4px var(--theme-primary-light), 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }

  .input-with-icon input::placeholder {
    color: #9ca3af;
    font-weight: 400;
  }

  .save-mobile-btn {
    background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
    color: #ffffff;
    border: none;
    border-radius: 16px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    white-space: nowrap;
    box-shadow: 0 4px 16px var(--theme-primary-light);
    min-width: 120px;
    justify-content: center;
  }

  .save-mobile-btn:hover {
    background: linear-gradient(135deg, var(--theme-primary-hover) 0%, var(--theme-primary) 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--theme-primary-light);
  }

  .save-mobile-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px var(--theme-primary-light);
  }

  .save-mobile-btn:disabled {
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    transform: none;
    cursor: not-allowed;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .help-text {
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    border-left: 4px solid var(--theme-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .help-text::before {
    content: '\f05a';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    color: var(--theme-primary);
    font-size: 0.9rem;
  }

  .mobile-display-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 16px;
    border: 2px solid #e2e8f0;
  }

  .mobile-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
  }

  .mobile-number {
    font-size: 1rem;
    font-weight: 600;
    color: #1a1a1a;
    font-family: 'Segoe UI', monospace;
    letter-spacing: 0.5px;
  }

  .mobile-actions {
    display: flex;
    gap: 0.75rem;
  }

  .btn-action.secondary {
    background: #ffffff;
    color: #6b7280;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.75rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .btn-action.secondary:hover {
    background: #f3f4f6;
    color: #374151;
    border-color: #d1d5db;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .btn-action.primary {
    background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
    color: #ffffff;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    width: auto;
    gap: 0.5rem;
    border: none;
    box-shadow: 0 4px 12px var(--theme-primary-light);
    transition: all 0.3s ease;
  }

  .btn-action.primary:hover {
    background: linear-gradient(135deg, var(--theme-primary-hover) 0%, var(--theme-primary) 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px var(--theme-primary-light);
  }

  .support-card .profile-card-body {
    text-align: center;
  }

  .support-card p {
    margin-bottom: 0.75rem;
    color: #6c757d;
    font-size: 0.9rem;
  }

  .support-email {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--theme-primary);
    color: #ffffff;
    text-decoration: none;
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }

  .support-email:hover {
    background: var(--theme-primary-hover);
    color: #ffffff;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px var(--theme-primary-light);
  }

  /* ===== MOBILE VERIFICATION MODAL STYLES ===== */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .verification-modal {
    background: #ffffff;
    border-radius: 20px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    transform: scale(0.9);
    animation: modalAppear 0.3s ease forwards;
  }

  @keyframes modalAppear {
    to {
      transform: scale(1);
    }
  }

  .verification-modal-header {
    background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
    color: #ffffff;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .verification-modal-header h5 {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .modal-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .verification-modal-body {
    padding: 2rem;
  }

  .verification-step {
    text-align: center;
  }

  .verification-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-hover) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    box-shadow: 0 8px 24px var(--theme-primary-light);
  }

  .verification-icon i {
    font-size: 1.5rem;
    color: #ffffff;
  }

  .verification-step h6 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 0.5rem;
  }

  .verification-step p {
    color: #6c757d;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .phone-display {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    font-weight: 600;
    color: #1a1a1a;
  }

  .phone-display i {
    color: var(--theme-primary);
  }

  .otp-input-container {
    margin-bottom: 1.5rem;
  }

  .otp-input-container input {
    width: 100%;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.5rem;
    color: #1a1a1a;
    background: #f8f9fa;
    transition: all 0.3s ease;
  }

  .otp-input-container input:focus {
    outline: none;
    border-color: var(--theme-primary);
    background: #ffffff;
    box-shadow: 0 0 0 3px var(--theme-primary-light);
  }

  .verification-btn {
    width: 100%;
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .verification-btn.primary {
    background: var(--theme-primary);
    color: #ffffff;
    margin-bottom: 0.75rem;
  }

  .verification-btn.primary:hover {
    background: var(--theme-primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px var(--theme-primary-light);
  }

  .verification-btn.secondary {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #e9ecef;
  }

  .verification-btn.secondary:hover {
    background: #e9ecef;
    color: #495057;
  }

  .verification-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  @media (max-width: 576px) {
    .profile-modern-container {
      padding: 0.5rem;
    }

    .profile-content {
      padding: 0.75rem;
    }

    .profile-avatar-section {
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 0.5rem;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
    }

    .profile-avatar i {
      font-size: 2.5rem;
    }

    .info-row {
      flex-direction: column;
      gap: 0.5rem;
    }

    .mobile-input-group {
      flex-direction: column;
      gap: 0.75rem;
    }

    .input-with-icon input {
      padding: 0.75rem 1rem 0.75rem 3rem;
      font-size: 0.9rem;
    }

    .save-mobile-btn {
      width: 100%;
      min-width: unset;
      padding: 0.75rem;
      font-size: 0.85rem;
    }

    .help-text {
      padding: 0.5rem 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }

    .mobile-display-row {
      flex-direction: column;
      align-items: stretch;
      gap: 0.5rem;
      padding: 0.75rem 0.5rem;
    }

    .mobile-info {
      justify-content: center;
      flex-direction: column;
      text-align: center;
      gap: 0.5rem;
    }

    .mobile-actions {
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .btn-action.primary {
      min-width: 100px;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .verification-modal {
      margin: 0.5rem;
    }

    .verification-modal-body {
      padding: 1rem;
    }
  }
</style>


<!-- Main Content Area -->
<div class="main-container booking-page">
  <h1 class="visually-hidden">Book Your Table</h1>
  <div class="tab-content" id="bookingTabsContent">
    <!-- Book Poker Tab Pane -->
    <div class="tab-pane fade show active" id="book-poker" role="tabpanel" aria-labelledby="book-poker-tab">
      <div class="booking-card">
        <!-- Sticky Header -->
        <div class="booking-header">
<div class="d-flex align-items-center justify-content-center position-relative">
  <!-- Back Arrow -->
  <button
    type="button"
    class="btn btn-link position-absolute start-0"
    onclick="goToPreviousStep()"
    style="text-decoration: none;"
  >
    <i class="fas fa-arrow-left fa-lg text-dark"></i>
  </button>

  <!-- Title -->
  <div class="text-center">
    <h6 class="fw-bold text-dark mb-0">
      {% trans "Book Your Day at MG" %}
    </h6>
    <p class="text-muted mb-1" style="font-size: 0.75rem;">
      Premium poker experience
    </p>
    <div class="d-flex justify-content-center">
      <span style="font-size: 0.9rem; color: var(--theme-red);">
        ‚ô†Ô∏é ‚ô•Ô∏é ‚ô£Ô∏é ‚ô¶Ô∏é
      </span>
    </div>
  </div>
</div>

        </div>
        
        <!-- Sticky Step Indicators -->
        <div class="booking-steps">
          <div class="step-indicator">
            <div class="step completed" data-step="1">1</div>
            <div class="step pending" data-step="2">2</div>
            <div class="step pending" data-step="3">3</div>
          </div>
        </div>
        
        <!-- Scrollable Content -->
        <div class="booking-content">
          {% include "bookings/booking_form.html" %}
        </div>
        
        <!-- Sticky Navigation Buttons -->
        <div class="booking-nav-buttons">
          <!-- Step 1: Only Next button -->
          <div class="nav-buttons-step1">
            <button type="button" class="btn btn-primary-custom w-100 next-step">
              {% trans "Next Step" %} <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
          
          <!-- Step 2: Back and Next buttons -->
          <div class="nav-buttons-step2" style="display: none;">
            <div class="row g-1">
              <div class="col-12">
                <button type="button" class="btn btn-primary-custom w-100 next-step">
                  {% trans "Next" %} <i class="fas fa-arrow-right ms-1"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Step 3: Back and Pay buttons -->
<!-- Step 3: Pay buttons only -->
<div class="nav-buttons-step3" style="display: none;">
  <div class="row g-2">
    <div class="col-6">
      <div id="stripePayNavSlot"></div>
    </div>

    <div class="col-6">
    <button
      type="button"
      id="payWithCashBtn"
      class="btn btn-secondary-custom w-100"
    >
      Pay with Cash
    </button>

    </div>
  </div>
</div>


        </div>
      </div>
    </div>
    
    <!-- My Bookings Tab Pane -->
    <div class="tab-pane fade" id="my-bookings" role="tabpanel" aria-labelledby="my-bookings-tab">
      <!-- Bookings List Container -->
      <div id="bookings-list-container">
        <div class="booking-card mb-2">
          <div class="card-body p-2">
            <div class="text-center mb-2">
              <h6 class="fw-bold text-dark mb-0">My Bookings</h6>
            </div>
            
            <!-- Filter Section -->
            <div class="mb-2">
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                  <i class="fas fa-calendar-alt text-muted"></i>
                </span>
                <input type="date" class="form-control border-start-0" id="filterDate" placeholder="Select Date" />
                <button class="btn btn-primary-custom" id="applyFilterBtn" type="button">
                  <i class="fas fa-filter me-1"></i>Filter
                </button>
              </div>
            </div>
          </div>
        </div>
          <div id="my-bookings-loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your bookings...</p>
          </div>
          <div id="my-bookings-container" style="display: none;"></div>
          <div id="no-bookings-message" class="text-center" style="display: none;">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <p class="text-muted">You currently have no bookings.</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Inline Edit Booking Container (hidden by default) -->
        <div id="edit-booking-container" class="d-none">
          <button id="back-to-bookings" class="btn btn-link mb-3">
            <i class="fas fa-arrow-left"></i> {% trans "Back to Bookings" %}
          </button>
          <div class="card border-0 shadow-sm"
               style="border: 2px solid #333; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <div class="card-body" style="background-color: #fff;">
              <h2 class="text-center mb-4" style="font-weight: bold; color: #333;">
                {% trans "Edit My Bookings" %}
                <span style="font-size: 1.3rem; margin-left: 10px;">‚ô†Ô∏é ‚ô•Ô∏é ‚ô£Ô∏é ‚ô¶Ô∏é</span>
              </h2>
              {% include "bookings/booking_edit_form.html" %}
            </div>
          </div>
        </div>
      </div>
    <!-- Profile Tab Pane -->
    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
      <div class="profile-modern-container">

        <!-- Profile Header Card -->
        <div class="profile-header-card">
          <div class="profile-background-gradient"></div>
          <div class="profile-content">
            <div class="profile-avatar-section">
              <div class="profile-avatar">
                <i class="fas fa-user-circle"></i>
                <div class="verification-indicator" id="verification-status">
                  <i class="fas fa-check-circle" title="Verified Account"></i>
                </div>
              </div>
              <div class="profile-title">
                <h4 class="profile-name" id="profile-display-name">Loading...</h4>
                <p class="profile-subtitle">Premium Member</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Information Cards -->
        <div id="profile-info" style="display: none;">
          <!-- Personal Information Card -->
          <div class="profile-info-card">
            <div class="profile-card-header">
              <i class="fas fa-user"></i>
              <h6>Personal Information</h6>
            </div>
            <div class="profile-card-body">
              <div class="info-row">
                <div class="info-item">
                  <label>First Name</label>
                  <span id="profile-first-name">-</span>
                </div>
                <div class="info-item">
                  <label>Last Name</label>
                  <span id="profile-last-name">-</span>
                </div>
              </div>
              <div class="info-row">
                <div class="info-item full-width">
                  <label>Email Address</label>
                  <div class="info-with-badge">
                    <span id="profile-email">-</span>
                    <span class="verified-badge" id="email-verified" style="display: none;">
                      <i class="fas fa-check"></i> Verified
                    </span>
                  </div>
                </div>
              </div>
              <div class="info-row">
                <div class="info-item full-width">
                  <label>Member Since</label>
                  <span id="profile-member-since">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Mobile Verification Card -->
          <div class="profile-info-card">
            <div class="profile-card-header">
              <i class="fas fa-mobile-alt"></i>
              <h6>Mobile Number</h6>
            </div>
            <div class="profile-card-body">

              <!-- Mobile Number Input Section -->
              <div id="mobile-input-section">
                <div class="mobile-input-group">
                  <div class="input-with-icon">
                    <i class="fas fa-mobile-alt"></i>
                    <input type="tel" id="profile-phone-input"
                           placeholder="Enter mobile number (+49 123 456 789)">
                  </div>
                  <button class="save-mobile-btn" type="button" id="save-mobile-btn" onclick="saveMobileNumber()">
                    <i class="fas fa-save"></i>
                    Save
                  </button>
                </div>
                <div class="help-text">Include country code (e.g., +49 for Germany)</div>
              </div>

              <!-- Mobile Number Display Section -->
              <div id="mobile-display-section" style="display: none;">
                <div class="mobile-display-row">
                  <div class="mobile-info">
                    <span class="mobile-number" id="profile-phone">-</span>
                    <span class="verified-badge verified" id="phone-verified" style="display: none;">
                      <i class="fas fa-check"></i> Verified
                    </span>
                    <span class="verified-badge unverified" id="phone-unverified" style="display: none;">
                      <i class="fas fa-exclamation"></i> Not Verified
                    </span>
                  </div>
                  <div class="mobile-actions">
                    <button class="btn-action secondary" id="edit-mobile-btn" onclick="editMobileNumber()">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-action primary" id="verify-phone-btn" style="display: none;" onclick="openMobileVerification()">
                      <i class="fas fa-shield-alt"></i>
                      Verify
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Support Card -->
          <div class="profile-info-card support-card">
            <div class="profile-card-header">
              <i class="fas fa-headset"></i>
              <h6>Need Help?</h6>
            </div>
            <div class="profile-card-body">
              <p>For special requests or support:</p>
              <a href="mailto:mgen@ming-group.de" class="support-email">
                <i class="fas fa-envelope"></i>
                mgen@ming-group.de
              </a>
            </div>
          </div>
        </div>
          
          <!-- Loading State -->
          <div id="profile-loading" class="text-center py-4">
            <div class="spinner-border text-primary mb-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted small">Loading profile...</p>
          </div>
          
          <!-- Error State -->
          <div id="profile-error" class="text-center py-4" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
            <p class="text-muted small">Unable to load profile</p>
            <button class="btn btn-sm btn-outline-primary" onclick="loadProfile()">Try Again</button>
          </div>
        </div>
      </div>
      
      <!-- Mobile Verification Modal -->
      <div class="modal-overlay" id="mobileVerificationModal" style="display: none;">
        <div class="verification-modal">
          <div class="verification-modal-header">
            <h5>Verify Mobile Number</h5>
            <button type="button" class="modal-close-btn" onclick="closeMobileModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="verification-modal-body">
            <!-- Step 1: Send OTP -->
            <div id="verification-step-1" class="verification-step">
              <div class="verification-icon">
                <i class="fas fa-mobile-alt"></i>
              </div>
              <h6>Verify Your Number</h6>
              <p>We'll send a verification code to your mobile number</p>

              <div class="phone-display">
                <i class="fas fa-phone"></i>
                <span id="modal-phone-display"></span>
              </div>

              <button class="verification-btn primary" id="send-otp-btn">
                <i class="fas fa-paper-plane"></i>
                Send Verification Code
              </button>
            </div>

            <!-- Step 2: Verify OTP -->
            <div id="verification-step-2" class="verification-step" style="display: none;">
              <div class="verification-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <h6>Enter Verification Code</h6>
              <p>Enter the 6-digit code sent to your mobile</p>

              <div class="otp-input-container">
                <input type="text" id="otp-input"
                       placeholder="000000"
                       maxlength="6"
                       pattern="[0-9]{6}"
                       inputmode="numeric">
              </div>

              <div class="verification-buttons">
                <button class="verification-btn primary" id="verify-otp-btn">
                  <i class="fas fa-check"></i>
                  Verify Code
                </button>
                <button class="verification-btn secondary" id="resend-otp-btn">
                  <i class="fas fa-redo"></i>
                  Resend Code
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modern Bottom Navigation -->
<nav class="navbar fixed-bottom bottom-nav">
  <div class="container-fluid">
    <div class="row w-100 text-center">
      <div class="col-4">
        <a class="nav-tab active" id="book-poker-tab" href="#" onclick="switchTab('book-poker', this); return false;" role="tab" aria-controls="book-poker" aria-selected="true">
          <i class="fas fa-dice"></i>
          <span>{% trans "Book Day" %}</span>
        </a>
      </div>
      <div class="col-4">
        <a class="nav-tab" id="my-bookings-tab" href="#" onclick="switchTab('my-bookings', this); return false;" role="tab" aria-controls="my-bookings" aria-selected="false">
          <i class="fas fa-calendar-check"></i>
          <span>{% trans "My Bookings" %}</span>
        </a>
      </div>
      <div class="col-4">
        <a class="nav-tab" id="profile-tab" href="#" onclick="switchTab('profile', this); return false;" role="tab" aria-controls="profile" aria-selected="false">
          <i class="fas fa-user-circle"></i>
          <span>{% trans "Profile" %}</span>
        </a>
      </div>
    </div>
  </div>
</nav>


<!-- Include Braintree Drop-in Library -->
<!-- <script src="https://js.braintreegateway.com/web/dropin/1.38.0/js/dropin.min.js"></script> -->

<!-- Consolidated JavaScript for both New & Edit Booking Forms -->
<script>

function goToPreviousStep() {
  if (window.currentStep > 1) {
    document.querySelector('.prev-step')?.click();
  }
}

// Step management function
window.showStep = function(stepNumber) {
  // Hide all steps
  const allSteps = document.querySelectorAll('.form-step');
  allSteps.forEach(step => step.classList.remove('active'));
  
  // Show target step
  const targetStep = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
  if (targetStep) {
    targetStep.classList.add('active');
    window.currentStep = stepNumber;
    
  }
};

// Custom tab switching function to replace Bootstrap (defined globally)
window.switchTab = function(tabId, clickedTab) {
  // Hide all tab panes
  const allPanes = document.querySelectorAll('.tab-pane');
  allPanes.forEach(pane => {
    pane.classList.remove('show', 'active');
    pane.classList.add('fade');
  });
  
  // Remove active class from all nav tabs
  const allTabs = document.querySelectorAll('.nav-tab');
  allTabs.forEach(tab => {
    tab.classList.remove('active');
    tab.setAttribute('aria-selected', 'false');
  });
  
  // Show selected tab pane
  const targetPane = document.getElementById(tabId);
  if (targetPane) {
    targetPane.classList.remove('fade');
    targetPane.classList.add('show', 'active');
  }
  
  // Make clicked tab active (if provided)
  if (clickedTab) {
    clickedTab.classList.add('active');
    clickedTab.setAttribute('aria-selected', 'true');
  }
  
  // Load bookings when My Bookings tab is clicked
  if (tabId === 'my-bookings') {
    // Make sure loadMyBookings is available
    if (typeof window.loadMyBookings === 'function') {
      window.loadMyBookings();
    }
  }
  
  // Load profile when Profile tab is clicked
  if (tabId === 'profile') {
    if (typeof window.loadProfile === 'function') {
      window.loadProfile();
    }
  }
  
  // Handle booking tab - check mobile verification and reset form
  if (tabId === 'book-poker') {
    // Reset booking form to step 1
    resetBookingFormToStep1();

    // Check mobile verification status when switching to booking tab
    if (typeof window.checkMobileVerification === 'function') {
      window.checkMobileVerification();
    }
    console.log('Switched to booking tab and reset to step 1');
  }
};


async function validateStep(stepIndex) {
  const step = document.querySelector(`.form-step[data-step="${stepIndex + 1}"]`);
  if (!step) {
    // If step doesn't exist, don't block user ‚Äì just allow it
    return true;
  }

  const inputs = step.querySelectorAll(
    'input:not([type="hidden"]):not([type="checkbox"]), select'
  );

  let isValid = true;

  inputs.forEach(input => {
    // Super defensive: if something weird is in the NodeList, just skip it
    if (!input || !input.classList) {
      return;
    }

    const value = (input.value || '').toString().trim();

    if (!value) {
      input.classList.add('is-invalid');
      isValid = false;
    } else {
      input.classList.remove('is-invalid');
    }
  });

  return isValid;
}

// Get numeric total amount from the pricing card (e.g. "‚Ç¨540.00" -> 540)
function getTotalAmountFromUI() {
  const totalAmountEl = document.getElementById('totalAmount');
  if (!totalAmountEl) return 0;

  const rawText = (totalAmountEl.textContent || '').trim(); // e.g. "‚Ç¨540.00"
  // Remove everything except digits, dot and comma
  const cleaned = rawText.replace(/[^\d.,]/g, '');

  // If you only use "." as decimal separator, this is enough:
  const value = parseFloat(cleaned.replace(',', '.')) || 0;

  return value;
}

// Function to reset booking form to step 1
function resetBookingFormToStep1() {
  // Reset to first step
  window.currentStep = 1;

  // Show only the first step
  const steps = document.querySelectorAll('.form-step');
  steps.forEach((step, index) => {
    if (index === 0) {
      step.classList.add('active');
    } else {
      step.classList.remove('active');
    }
  });

  // Update step indicators
  const stepIndicators = document.querySelectorAll('.step');
  stepIndicators.forEach((indicator, index) => {
    if (index === 0) {
      indicator.className = 'step active';
    } else {
      indicator.className = 'step pending';
    }
  });

  // Update navigation buttons visibility
  const navButtonContainers = document.querySelectorAll('[class*="nav-buttons-step"]');
  navButtonContainers.forEach((container, index) => {
    container.style.display = index === 0 ? 'block' : 'none';
  });

  // Reset form fields for a fresh start
  const bookingForm = document.getElementById('bookingForm');
  if (bookingForm) {
    // Reset date and time fields
    const dateInput = document.getElementById('bookingDate');
    const timeSelect = document.getElementById('bookingTime');
    const durationSelect = document.getElementById('bookingDuration');
    const peopleInput = document.getElementById('numberOfPeople');

    if (dateInput) dateInput.value = '';
    if (timeSelect) timeSelect.innerHTML = '<option value="">Select Date Fi</option>';
    if (durationSelect) durationSelect.innerHTML = '<option value="">Select Time First</option>';
    if (peopleInput) peopleInput.value = '';

    // Uncheck service checkboxes
    const dealerCheckbox = document.getElementById('dealerService');
    const serviceCheckbox = document.getElementById('servicePersonal');
    const drinksCheckbox = document.getElementById('drinksFlatrate');

    if (dealerCheckbox) dealerCheckbox.checked = false;
    if (serviceCheckbox) serviceCheckbox.checked = false;
    if (drinksCheckbox) drinksCheckbox.checked = false;

    // Reset any validation states
    const inputs = bookingForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.classList.remove('is-invalid');
      const errorMessage = input.parentNode.querySelector('.error-message');
      if (errorMessage) {
        errorMessage.remove();
      }
    });
  }

  console.log('Booking form reset to step 1 - ready for new booking');
}

document.addEventListener('DOMContentLoaded', async function() {
  let braintreeInitialized = false;
const termsCheckbox = document.getElementById('agreeTerms');
const termsError = document.getElementById('termsError');

if (termsCheckbox) {
  termsCheckbox.addEventListener('change', () => {
    if (termsCheckbox.checked) {
      if (termsError && termsError.classList) {
        termsError.classList.add('d-none');
      }
      termsCheckbox.classList.remove('is-invalid');
    }
  });
}

  // Initialize current step variable
  window.currentStep = 1;
  
  
  // Check mobile verification on page load
  setTimeout(() => {
    if (typeof window.checkMobileVerification === 'function') {
      window.checkMobileVerification();
    }
  }, 2000);
  
  // Function to initialize Braintree when step 3 becomes visible
  async function initializeBraintree() {
    console.log('initializeBraintree called, initialized:', braintreeInitialized);
    
    if (braintreeInitialized) return;
    
    var dropinContainer = document.getElementById('dropin-container');
    console.log('Dropin container found:', dropinContainer);
    
    if (!dropinContainer) {
      console.error('Dropin container element not found.');
      return;
    }
    
    try {
      // Fetch the client token from your endpoint
      const response = await fetch('/payments/braintree/client-token/');
      if (!response.ok) {
        throw new Error('Network response was not ok.');
      }
      const clientToken = await response.text();
      
      console.log('About to create Braintree dropin with token:', clientToken.substring(0, 20) + '...');
      // Initialize the Braintree drop-in UI with the retrieved client token.
      braintree.dropin.create({
        authorization: clientToken,
        container: '#dropin-container',
        paypal: {
          flow: 'vault' 
        }
      }, function (createErr, instance) {
        if (createErr) {
          console.error('Error creating dropin UI:', createErr);
          return;
        }
        window.braintreeInstance = instance;
        braintreeInitialized = true;
        console.log('Braintree dropin UI initialized successfully, instance:', instance);
        
        // Debug: Check if UI was injected
        setTimeout(() => {
          const container = document.getElementById('dropin-container');
          console.log('Dropin container after init:', container);
          console.log('Container innerHTML:', container.innerHTML);
          console.log('Container children count:', container.children.length);
        }, 1000);
      });
    } catch (error) {
      console.error('Error fetching client token:', error);
    }
  }
  window.user_id = "{{ request.session.user_id|default:'' }}";
  const user_id = "{{ request.session.user_id|default:'' }}";
  let allBookings = []; // Global variable for bookings
  
  // Initialize Braintree when step 3 is reached
  window.initializeBraintreeOnStep3 = initializeBraintree;
  
  // Check if braintree library is loaded
  console.log('Braintree library available:', typeof braintree);
  
  // Try to initialize immediately if step 3 is already visible
  setTimeout(() => {
    const step3 = document.querySelector('.form-step[data-step="3"]');
    if (step3 && step3.classList.contains('active')) {
      console.log('Step 3 already active, initializing Braintree');
      initializeBraintree();
    }
  }, 1000);

  // --- Helper Functions ---
  function formatHour(hour) {
    var displayHour = hour % 12 === 0 ? 12 : hour % 12;
    var ampm = hour < 12 ? "AM" : "PM";
    return displayHour + ":00 " + ampm;
  }
  
  
  // --- Booking List & Other Logic ---
  function renderBookings(bookings) {
    const container = document.getElementById('my-bookings-container');
    container.innerHTML = '';
    if (!bookings || bookings.length === 0) {
      document.getElementById('no-bookings-message').style.display = 'block';
      return;
    } else {
      document.getElementById('no-bookings-message').style.display = 'none';
    }
    
    bookings.forEach(booking => {
      // Parse and format the date
      const bookingDate = new Date(booking.start_time.replace(' ', 'T'));
      const formattedDate = bookingDate.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
      const formattedTime = bookingDate.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true
      });
    // Compute end time from start_time + hours_booked
    const startDt = new Date(booking.start_time.replace(' ', 'T'));
    const hoursBooked = Number(booking.hours_booked || booking.duration_hours || 0);
    const endDt = new Date(startDt.getTime() + hoursBooked * 60 * 60 * 1000);

    const formattedStart = startDt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    const formattedEnd   = endDt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

    // What to show for ‚ÄúDuration‚Äù
    const durationText = hoursBooked
      ? `${formattedStart} ‚Äì ${formattedEnd} (${hoursBooked} ${hoursBooked === 1 ? 'hour' : 'hours'})`
      : `${formattedStart}`;

      const statusClass = booking.is_cancelled ? 'status-cancelled' : 'status-active';
      const statusText = booking.is_cancelled ? 'Cancelled' : 'Active';
      const statusIcon = booking.is_cancelled ? 'fas fa-times-circle' : 'fas fa-check-circle';

const cashFee = parseFloat(booking.cash_rounding_fee || 0);
const depositAmount = parseFloat(booking.deposit_amount || 0);
const bookingAmount = parseFloat(booking.total_amount || 0);
let displayTotal = 0;
let paymentNote = "";

if (booking.is_cash) {
  // cash total = booking + deposit + rounding fee
  displayTotal = bookingAmount + depositAmount + cashFee;

  // show note depending on paid status
  paymentNote = booking.cash_paid ? " (paid by cash)" : " (to be paid)";
} else {
  // stripe booking => paid online (booking + deposit)
  displayTotal = bookingAmount + depositAmount;
  paymentNote = " (paid online)";
}

      const card = `
        <div class="booking-card-modern"
             data-booking-id="${booking.id}"
             data-booking-date="${booking.start_time}"
             data-booking-time="${booking.start_time}"
             data-total-people="${booking.total_people}"
             data-hours="${booking.hours_booked}"
             data-drinks="${booking.drinks.join(',')}">
          
          <div class="booking-card-header">
            <div class="booking-date-info">
              <div class="booking-date">${formattedDate}</div>
              <div class="booking-time">${formattedTime}</div>
            </div>
            <div class="booking-status ${statusClass}">
              <i class="${statusIcon}"></i>
              <span>${statusText}</span>
            </div>
          </div>
          
          <div class="booking-card-body">
            <div class="booking-details-row">
              <div class="booking-detail">
                <div class="detail-label">
                  <i class="fas fa-users"></i>
                  People
                </div>
                <div class="detail-value">${booking.total_people}</div>
              </div>
              
              <div class="booking-detail">
                <div class="detail-label">
                  <i class="fas fa-clock"></i>
                  Duration
                </div>
                <div class="detail-value">${durationText}</div>
              </div>
              
              <div class="booking-detail">
                <div class="detail-label">
                  <i class="fas fa-euro-sign"></i>
                  Total
                </div>
                <div class="detail-value">‚Ç¨${displayTotal.toFixed(2)}${paymentNote}</div>
              </div>
            </div>
            
            ${booking.drinks.length > 0 ? `
            <div class="booking-drinks">
              <div class="drinks-label">
                <i class="fas fa-cocktail"></i>
                Drinks
              </div>
              <div class="drinks-list">
                ${booking.drinks.map(drink => `<span class="drink-tag">${drink}</span>`).join('')}
              </div>
            </div>
            ` : ''}
          </div>
          
<div class="booking-card-actions">
  ${(() => {
    // booking.start_time is already used above in your code
    const startDt = new Date(booking.start_time.replace(' ', 'T'));
    const isPast = startDt.getTime() <= Date.now();

    if (booking.is_cancelled) {
      return `<button class="btn-action btn-cancelled cancel-booking" disabled>
                <i class="fas fa-ban"></i>
                <span>Cancelled</span>
              </button>`;
    }

    // ‚úÖ past booking => no cancel button at all
    if (isPast) return '';

    // future booking => show cancel button (your existing logic)
    const cancellationInfo = checkCancellationPolicy(booking.booking_date);
    const buttonClass = cancellationInfo.isWithin24Hours ? 'btn-cancel-warning' : 'btn-cancel';
    const warningIcon = cancellationInfo.isWithin24Hours ? 'fa-exclamation-triangle' : 'fa-times';

    return `<button class="btn-action ${buttonClass} cancel-booking"
                    data-booking-id="${booking.id}"
                    data-booking-date="${booking.booking_date}"
                    title="${cancellationInfo.isWithin24Hours ? 'Warning: Cancellation fee applies' : 'Free cancellation available'}">
              <i class="fas ${warningIcon}"></i>
              <span>${cancellationInfo.isWithin24Hours ? 'Cancel*' : 'Cancel'}</span>
            </button>`;
  })()}
</div>

        </div>
      `;
      container.innerHTML += card;
    });
    container.style.display = 'block';
  }
  
  window.loadMyBookings = function() {
    document.getElementById('my-bookings-loading').style.display = 'block';
    document.getElementById('my-bookings-container').style.display = 'none';
    document.getElementById('no-bookings-message').style.display = 'none';
    fetch('/bookings/get-user-bookings/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ 'customer_id': user_id })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      document.getElementById('my-bookings-loading').style.display = 'none';
      allBookings = data.bookings || [];
      renderBookings(allBookings);
    })
    .catch(error => {
      console.error('Error fetching bookings:', error);
      document.getElementById('my-bookings-loading').style.display = 'none';
      document.getElementById('my-bookings-container').innerHTML = `
        <p class="text-center text-danger">Error loading bookings. Please try again later.</p>`;
    });
  }
  
  document.getElementById('applyFilterBtn').addEventListener('click', function() {
    const selectedDate = document.getElementById('filterDate').value;
    if (!selectedDate) {
      renderBookings(allBookings);
      return;
    }
    const filtered = allBookings.filter(booking => {
      const bDate = new Date(booking.start_time.replace(' ', 'T'));
      const bDateString = bDate.toISOString().split('T')[0];
      return bDateString === selectedDate;
    });
    renderBookings(filtered);
  });
  
  // --- Back Button for Edit Form ---
  document.getElementById('back-to-bookings').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('edit-booking-container').classList.add('d-none');
    document.getElementById('bookings-list-container').classList.remove('d-none');
  });

  // --- Cancel Booking Functionality ---
  document.addEventListener('click', function(e) {
    if (e.target.closest('.cancel-booking')) {
      const button = e.target.closest('.cancel-booking');
      const bookingId = button.getAttribute('data-booking-id');
      const bookingDate = button.getAttribute('data-booking-date');

      // Check if this is within 24 hours of booking time
      const cancellationInfo = checkCancellationPolicy(bookingDate);

      if (cancellationInfo.isWithin24Hours) {
        // Show warning message for late cancellation
        const confirmMessage = `‚ö†Ô∏è CANCELLATION POLICY WARNING ‚ö†Ô∏è\n\n` +
          `You are cancelling within 24 hours of your booking time.\n\n` +
          `According to our policy:\n` +
          `‚Ä¢ A cancellation fee will be charged\n` +
          `‚Ä¢ ${cancellationInfo.feePercentage}% of the booking amount will be debited\n` +
          `‚Ä¢ Remaining amount will be refunded\n\n` +
          `Time remaining: ${cancellationInfo.timeRemaining}\n\n` +
          `Do you still want to proceed with cancellation?`;

        const confirmed = confirm(confirmMessage);
        if (confirmed) {
          cancelBooking(bookingId, button, true); // true = late cancellation
        }
      } else {
        // Normal cancellation
        const confirmMessage = `Are you sure you want to cancel this booking?\n\n` +
          `‚úÖ No cancellation fee applies (more than 24 hours remaining)\n` +
          `‚úÖ Full refund will be processed\n\n` +
          `This action cannot be undone.`;

        const confirmed = confirm(confirmMessage);
        if (confirmed) {
          cancelBooking(bookingId, button, false); // false = normal cancellation
        }
      }
    }
  });

  // Function to check cancellation policy
  function checkCancellationPolicy(bookingDateString) {
    const bookingDateTime = new Date(bookingDateString);
    const currentTime = new Date();
    const timeDifference = bookingDateTime.getTime() - currentTime.getTime();
    const hoursRemaining = timeDifference / (1000 * 3600);

    const isWithin24Hours = hoursRemaining <= 24 && hoursRemaining > 0;

    let timeRemaining = '';
    if (hoursRemaining > 0) {
      if (hoursRemaining >= 24) {
        const daysRemaining = Math.floor(hoursRemaining / 24);
        const remainingHours = Math.floor(hoursRemaining % 24);
        timeRemaining = `${daysRemaining} day(s) ${remainingHours} hour(s)`;
      } else {
        timeRemaining = `${Math.floor(hoursRemaining)} hour(s) ${Math.floor((hoursRemaining % 1) * 60)} minute(s)`;
      }
    } else {
      timeRemaining = 'Booking time has passed';
    }

    return {
      isWithin24Hours: isWithin24Hours,
      hoursRemaining: hoursRemaining,
      timeRemaining: timeRemaining,
      feePercentage: 30 // 30% cancellation fee for late cancellations
    };
  }

  function cancelBooking(bookingId, button, isLateCancellation = false) {
    // Disable button and show loading state
    button.disabled = true;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Cancelling...</span>';

    fetch('/bookings/cancel-booking/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        'booking_id': bookingId,
        'customer_id': user_id,
        'is_late_cancellation': isLateCancellation
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        let message = 'Booking cancelled successfully!';

        if (isLateCancellation) {
          message += `\n\nüìã CANCELLATION DETAILS:\n` +
            `‚Ä¢ Cancellation fee: ${data.cancellation_fee || '30%'}\n` +
            `‚Ä¢ Refund amount: ‚Ç¨${data.refund_amount || 'TBD'}\n` +
            `‚Ä¢ Refund will be processed within 3-5 business days`;
        } else {
          message += '\n\n‚úÖ Full refund will be processed within 3-5 business days.';
        }

        alert(message);

        // Refresh the bookings list
        window.loadMyBookings();
      } else {
        alert('Error cancelling booking: ' + (data.message || 'Unknown error'));

        // Re-enable button
        button.disabled = false;
        button.innerHTML = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Network error. Please try again.');

      // Re-enable button
      button.disabled = false;
      button.innerHTML = originalText;
    });
  }
  
  const bookingDateInput = document.getElementById('bookingDate');
  const bookingTimeSelectSubmit = document.getElementById('bookingTime');
  const numberOfPeopleInput = document.getElementById('numberOfPeople');
  const numberOfHoursInput = document.getElementById('bookingDuration');

console.log('bookingDate', bookingDateInput?.value || 'null');
console.log('bookingTime', bookingTimeSelectSubmit?.value || 'null');
console.log('hours', numberOfHoursInput?.value || 'null');

  // --- Booking Form Submission ---
// --- Booking Form Submission (BANK TRANSFER ONLY) ---
document.getElementById('bookingForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  // Make sure fixed time & duration are set (18:00 ‚Äì 12:00 next day = 18 hours)
  const bookingTimeField = document.getElementById('bookingTime');
  const bookingDurationField = document.getElementById('bookingDuration');

  if (bookingTimeField) {
    bookingTimeField.innerHTML = '';
    const optTime = document.createElement('option');
    optTime.value = '18:00';
    optTime.textContent = '18:00';
    optTime.selected = true;
    bookingTimeField.appendChild(optTime);
  }

  if (bookingDurationField) {
    bookingDurationField.innerHTML = '';
    const optDur = document.createElement('option');
    optDur.value = '18';      // 18 hours
    optDur.textContent = '18';
    optDur.selected = true;
    bookingDurationField.appendChild(optDur);
  }

  // Use the global references already declared later in the file
  const bookingDate = bookingDateInput?.value || '';
  const numberOfPeople = numberOfPeopleInput?.value || '';
  const bookingTime = bookingTimeSelectSubmit?.value || '18:00';
  const bookingDuration = numberOfHoursInput?.value || '18';

  console.log('Form validation:', { bookingDate, bookingTime, bookingDuration, numberOfPeople });

  if (!bookingDate || !numberOfPeople) {
    alert('Please fill in all required fields (Date, Number of People)');
    return;
  }

  // Terms & conditions check
  const termsCheckbox = document.getElementById('agreeTerms');
  const termsError = document.getElementById('termsError');

  if (!termsCheckbox || !termsCheckbox.checked) {
    if (termsError){
      termsError.classList.remove('d-none')
    };
    termsCheckbox?.classList.add('is-invalid');
    alert('You must agree to the terms and conditions before booking.');
    return;
  } else {
    if (termsError) termsError.classList.add('d-none');
    termsCheckbox?.classList.remove('is-invalid');
  }

  // Optional: extra date check (kept from old code)
  const dateCheckResponse = await fetch('/bookings/get_unavailable_slots?date=' + bookingDateInput.value);
  const dateCheckData = await dateCheckResponse.json();
  console.log('dateCheckData', dateCheckData);

  // Read total amount that is shown in the pricing card
const totalAmount = window.bookingTotalAmount || 0;
console.log('Sending total_amount to backend:', totalAmount);


  // Availability check
  const availabilityResponse = await fetch('/bookings/check_availability/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: JSON.stringify({
      user_id: user_id,
      date: bookingDateInput.value,
      total_people: numberOfPeopleInput.value,
      start_time: bookingTime,        // will be 18:00
      hours_booked: bookingDuration,  // will be 18
      total_amount: totalAmount 
    })
  });

  const availabilityData = await availabilityResponse.json();
  console.log('availabilityData', availabilityData);
  if (!availabilityData.available) {
    alert(availabilityData.message || "Selected time slot is unavailable.");
    return;
  }

  // ---- BANK TRANSFER FLOW (no Braintree on frontend) ----
  const formData = {
    booking_date: bookingDate + "T" + bookingTime, // e.g. 2025-03-01T18:00
    number_of_people: numberOfPeople,
    number_of_hours: bookingDuration,
    drinks: Array.from(document.querySelectorAll('input[name="drinks"]:checked')).map(o => parseInt(o.value, 10)),

    // keep same field name for backend
    payment_method_nonce: 'BANK_TRANSFER',

    user_id: user_id,
    total_amount: totalAmount
  };

  try {
    const response = await fetch('/payments/braintree/process-payment/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify(formData)
    });

    const data = await response.json();
const msgBox = document.getElementById('bookingSubmitMessage');
['bookingDate', 'numberOfPeople', 'agreeTerms'].forEach(id => {
  const el = document.getElementById(id);
  el?.addEventListener('change', () => {
    const msgBox = document.getElementById('bookingSubmitMessage');
    if (msgBox) msgBox.classList.add('d-none');
  });
});
function showMsg(type, text) {
  if (!msgBox) return;
  msgBox.className = `alert alert-${type} mt-3`; // success | danger | warning | info
  msgBox.textContent = text;
  msgBox.classList.remove('d-none');
}

    if (response.ok && data.success) {
      // ‚úÖ stay on same step and show message
      showMsg('success', '‚úÖ Booking saved! Redirecting to your My Bookings‚Ä¶');

      // ‚úÖ DO NOT reset form here (this was sending you back to step 1 feeling)
      // document.getElementById('bookingForm').reset();

      // ‚úÖ after a short delay, go to My Bookings
      setTimeout(() => {
        const myBookingsTab = document.getElementById('my-bookings-tab');
        window.switchTab('my-bookings', myBookingsTab);

        // reload list
        if (typeof window.loadMyBookings === 'function') {
          window.loadMyBookings();
        }
      }, 1500);

    } else {
      // ‚ùå stay on same step, show error
      showMsg('danger', '‚ùå Booking failed: ' + (data.message || 'Could not save booking'));
    }

  } catch (error) {
    console.error(error);
    alert('Network error. Please try again.');
  }
});

  const params = new URLSearchParams(window.location.search);
  const tab = params.get("tab");

  if (tab === "my-bookings") {
    const btn = document.getElementById("my-bookings-tab");
    window.switchTab("my-bookings", btn);

    // clean URL (optional)
    window.history.replaceState({}, document.title, "/bookings/book/");
  }

  // Profile Management Functions
  window.loadProfile = function() {
    document.getElementById('profile-loading').style.display = 'block';
    document.getElementById('profile-info').style.display = 'none';
    document.getElementById('profile-error').style.display = 'none';
    
    fetch('/customers/api/profile/')
      .then(response => response.json())
      .then(data => {
        document.getElementById('profile-loading').style.display = 'none';
        
        if (data.success) {
          const customer = data.customer;

          // Populate profile information
          document.getElementById('profile-first-name').textContent = customer.first_name;
          document.getElementById('profile-last-name').textContent = customer.last_name;
          document.getElementById('profile-email').textContent = customer.email_id;
          document.getElementById('profile-member-since').textContent = customer.created_at;

          // Update profile display name
          const displayName = `${customer.first_name} ${customer.last_name}`;
          document.getElementById('profile-display-name').textContent = displayName;
          
          // Show verification status
          if (customer.is_email_verified) {
            document.getElementById('email-verified').style.display = 'inline-block';
          }
          
          // Handle mobile number display/input
          if (customer.phone_number && customer.phone_number.trim() !== '') {
            // User has a phone number - show display section
            document.getElementById('profile-phone').textContent = customer.phone_number;
            document.getElementById('mobile-input-section').style.display = 'none';
            document.getElementById('mobile-display-section').style.display = 'flex';
            
            if (customer.is_phone_verified) {
              document.getElementById('phone-verified').style.display = 'inline-block';
              document.getElementById('phone-unverified').style.display = 'none';
              document.getElementById('verify-phone-btn').style.display = 'none';
            } else {
              document.getElementById('phone-unverified').style.display = 'inline-block';
              document.getElementById('verify-phone-btn').style.display = 'inline-block';
              document.getElementById('phone-verified').style.display = 'none';
            }
          } else {
            // User has no phone number - show input section
            document.getElementById('mobile-input-section').style.display = 'block';
            document.getElementById('mobile-display-section').style.display = 'none';
          }
          
          document.getElementById('profile-info').style.display = 'block';
          
          // Store customer data for verification
          window.currentCustomer = customer;
          
        } else {
          document.getElementById('profile-error').style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error loading profile:', error);
        document.getElementById('profile-loading').style.display = 'none';
        document.getElementById('profile-error').style.display = 'block';
      });
  };

  // Mobile Number Management Functions
  window.saveMobileNumber = function() {
    const phoneInput = document.getElementById('profile-phone-input');
    const phoneNumber = phoneInput.value.trim();
    
    if (!phoneNumber) {
      alert('Please enter a mobile number');
      return;
    }
    
    // Basic phone validation
    const phoneRegex = /^\+?[\d\s\-\(\)]{8,}$/;
    if (!phoneRegex.test(phoneNumber)) {
      alert('Please enter a valid mobile number with country code (e.g., +49 123 456 789)');
      return;
    }
    
    const saveBtn = document.getElementById('save-mobile-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    
    fetch('/customers/api/update-phone/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        phone_number: phoneNumber
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Refresh the profile to show the updated phone number
        loadProfile();
        alert('Mobile number saved successfully!');
      } else {
        alert(data.message || 'Failed to save mobile number');
      }
    })
    .catch(error => {
      console.error('Error saving mobile number:', error);
      alert('Error saving mobile number. Please try again.');
    })
    .finally(() => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
    });
  };
  
  window.editMobileNumber = function() {
    const currentPhone = document.getElementById('profile-phone').textContent;
    document.getElementById('profile-phone-input').value = currentPhone;
    document.getElementById('mobile-input-section').style.display = 'block';
    document.getElementById('mobile-display-section').style.display = 'none';
  };

  // Mobile Verification Functions
  window.openMobileVerification = function() {
    if (!window.currentCustomer) {
      alert('Please refresh the profile first');
      return;
    }
    
    document.getElementById('modal-phone-display').textContent = window.currentCustomer.phone_number;
    document.getElementById('verification-step-1').style.display = 'block';
    document.getElementById('verification-step-2').style.display = 'none';
    document.getElementById('mobileVerificationModal').style.display = 'block';
  };

  window.closeMobileModal = function() {
    document.getElementById('mobileVerificationModal').style.display = 'none';
    document.getElementById('otp-input').value = '';
  };

  window.sendMobileOTP = function() {
    const sendBtn = document.getElementById('send-otp-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    
    fetch('/customers/api/send-mobile-otp/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        phone_number: window.currentCustomer.phone_number,
        customer_id: window.currentCustomer.id
      })
    })
    .then(response => response.json())
    .then(data => {
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Verification Code';
      
      if (data.success) {
        document.getElementById('verification-step-1').style.display = 'none';
        document.getElementById('verification-step-2').style.display = 'block';
        
        // Show OTP in console for testing (remove in production)
        console.log('OTP sent:', data.otp);
        alert(`OTP sent! For testing: ${data.otp}`); // Remove in production
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error sending OTP:', error);
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Verification Code';
      alert('Network error. Please try again.');
    });
  };

  window.verifyMobileOTP = function() {
    const otp = document.getElementById('otp-input').value;
    if (!otp || otp.length !== 6) {
      alert('Please enter a valid 6-digit code');
      return;
    }
    
    const verifyBtn = document.getElementById('verify-otp-btn');
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
    
    fetch('/customers/api/verify-mobile-otp/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        phone_number: window.currentCustomer.phone_number,
        customer_id: window.currentCustomer.id,
        otp: otp
      })
    })
    .then(response => response.json())
    .then(data => {
      verifyBtn.disabled = false;
      verifyBtn.innerHTML = '<i class="fas fa-check me-2"></i>Verify Code';
      
      if (data.success) {
        alert('Mobile number verified successfully!');
        window.closeMobileModal();
        window.loadProfile(); // Reload profile to show updated status
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error verifying OTP:', error);
      verifyBtn.disabled = false;
      verifyBtn.innerHTML = '<i class="fas fa-check me-2"></i>Verify Code';
      alert('Network error. Please try again.');
    });
  };

  // Event listeners for mobile verification (Profile tab only)
  const verifyPhoneBtn = document.getElementById('verify-phone-btn');
  if (verifyPhoneBtn) {
    verifyPhoneBtn.addEventListener('click', window.openMobileVerification);
  }
  
  const sendOtpBtn = document.getElementById('send-otp-btn');
  if (sendOtpBtn) {
    sendOtpBtn.addEventListener('click', window.sendMobileOTP);
  }
  
  const verifyOtpBtn = document.getElementById('verify-otp-btn');
  if (verifyOtpBtn) {
    verifyOtpBtn.addEventListener('click', window.verifyMobileOTP);
  }
  
  const resendOtpBtn = document.getElementById('resend-otp-btn');
  if (resendOtpBtn) {
    resendOtpBtn.addEventListener('click', window.sendMobileOTP);
  }
  
  const otpInput = document.getElementById('otp-input');
  if (otpInput) {
    otpInput.addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, ''); // Only allow digits
    });
    
    otpInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        window.verifyMobileOTP();
      }
    });
  }
  
  // Dynamic Booking Time Slots and Duration Management - with null checks
  const dynamicBookingDate = document.getElementById('bookingDate');
  const bookingTimeSelect = document.getElementById('bookingTime');
  const bookingDurationSelect = document.getElementById('bookingDuration');
  const timeSlotMessage = document.getElementById('timeSlotMessage');
  const durationMessage = document.getElementById('durationMessage');

  // Only proceed if the booking form elements exist
  if (!dynamicBookingDate || !bookingTimeSelect || !bookingDurationSelect) {
    console.log('Booking form elements not found - skipping dynamic booking setup');
    return;
  }

  // Set minimum date to today
  if (dynamicBookingDate) {
    const today = new Date().toISOString().split('T')[0];
    dynamicBookingDate.min = today;
  }

  // Store combined time-hours data for instant access
  let timeHoursData = {};

  // Base hourly rate (can be adjusted)
  const HOURLY_RATE = 50; // ‚Ç¨50 per hour
  let CURRENT_TOTAL_AMOUNT = 0;


  // Load available time slots when date changes
  if (dynamicBookingDate) {
    dynamicBookingDate.addEventListener('change', function() {
      const selectedDate = this.value;
      if (selectedDate) {
        //loadAvailableTimeSlots(selectedDate);
        // Reset selections
        //bookingTimeSelect.innerHTML = '<option value="">Loading...</option>';
        //bookingDurationSelect.innerHTML = '<option value="">Select Time First</option>';
        //updatePricing();
      }
    });
  }

  // Load available hours when time is selected (instant from pre-loaded data)
  if (bookingTimeSelect) {
    bookingTimeSelect.addEventListener('change', function() {
      const selectedDate = dynamicBookingDate.value;
      const selectedTime = this.value;

      if (selectedTime && timeHoursData[selectedTime]) {
        // Instantly populate hours from pre-loaded data (super fast!)
        populateHoursDropdown(timeHoursData[selectedTime]);
      } else if (selectedDate && selectedTime) {
        // Fallback: load hours dynamically if not pre-loaded
        bookingDurationSelect.innerHTML = '<option value="">Loading...</option>';
        fetch(`/bookings/get-available-durations/?date=${selectedDate}&start_time=${selectedTime}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              populateHoursDropdown(data.available_durations);
            } else {
              bookingDurationSelect.innerHTML = '<option value="">No hours available</option>';
            }
          })
          .catch(error => {
            console.error('Error loading hours:', error);
            bookingDurationSelect.innerHTML = '<option value="">Error loading hours</option>';
          });
      } else {
        bookingDurationSelect.innerHTML = '<option value="">Select Time First</option>';
        durationMessage.innerHTML = '<i class="fas fa-info-circle me-1"></i>Available hours based on selected time';
        durationMessage.className = 'form-text text-muted mt-1 small';
      }
      updatePricing();
    });
  }

  // Update pricing when duration changes
  if (bookingDurationSelect) {
    bookingDurationSelect.addEventListener('change', function() {
      updatePricing();
    });
  }
  
  // Function to load ALL time slots and hours data in ONE single API call
  function loadAvailableTimeSlots(date) {
    // Reset data
    timeHoursData = {};

    // ONE single API call that gets everything at once
    fetch(`/bookings/get-all-booking-data/?date=${date}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          bookingTimeSelect.innerHTML = '<option value="">Select Start Time</option>';

          if (!data.time_slots_with_hours || Object.keys(data.time_slots_with_hours).length === 0) {
            bookingTimeSelect.innerHTML = '<option value="">No available time slots</option>';
            timeSlotMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>No available time slots for this date due to MGEN-F24 events';
            timeSlotMessage.className = 'form-text text-warning mt-1 small';
          } else {
            // Store all the hours data (already loaded in one call!)
            timeHoursData = data.time_slots_with_hours;

            // Add each time slot as an option
            Object.keys(timeHoursData).forEach(timeSlot => {
              const option = document.createElement('option');
              option.value = timeSlot;
              option.textContent = timeSlot;
              bookingTimeSelect.appendChild(option);
            });

            timeSlotMessage.innerHTML = '<i class="fas fa-check me-1"></i>All data loaded instantly - time selection is now super fast!';
            timeSlotMessage.className = 'form-text text-success mt-1 small';
          }
        } else {
          bookingTimeSelect.innerHTML = '<option value="">Error loading time slots</option>';
          timeSlotMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error loading available time slots';
          timeSlotMessage.className = 'form-text text-danger mt-1 small';
        }
      })
      .catch(error => {
        console.error('Error loading time slots:', error);
        bookingTimeSelect.innerHTML = '<option value="">Error loading time slots</option>';
        timeSlotMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Network error loading time slots';
        timeSlotMessage.className = 'form-text text-danger mt-1 small';

        // Fallback to old method if new endpoint doesn't exist
        loadAvailableTimeSlotsOldWay(date);
      });
  }

  // Fallback function (in case backend endpoint doesn't exist yet)
  function loadAvailableTimeSlotsOldWay(date) {
    fetch(`/bookings/get-available-time-slots/?date=${date}`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.available_time_slots.length > 0) {
          bookingTimeSelect.innerHTML = '<option value="">Select Start Time</option>';

          data.available_time_slots.forEach(timeSlot => {
            const option = document.createElement('option');
            option.value = timeSlot;
            option.textContent = timeSlot;
            bookingTimeSelect.appendChild(option);
          });

          timeSlotMessage.innerHTML = '<i class="fas fa-info-circle me-1"></i>Using fallback method - hours will load when time is selected';
          timeSlotMessage.className = 'form-text text-info mt-1 small';
        }
      })
      .catch(error => {
        console.error('Fallback method also failed:', error);
      });
  }

  // Function to instantly populate hours dropdown from pre-loaded data
  function populateHoursDropdown(availableHours) {
    bookingDurationSelect.innerHTML = '<option value="">Select Hours</option>';

    if (!availableHours || availableHours.length === 0) {
      bookingDurationSelect.innerHTML = '<option value="">No hours available</option>';
      durationMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>No available hours for selected time';
      durationMessage.className = 'form-text text-warning mt-1 small';
    } else {
      // Add each duration as an option
      availableHours.forEach(duration => {
        const option = document.createElement('option');
        option.value = duration;
        const hourText = duration == 1 ? 'hour' : 'hours';
        option.textContent = `${duration} ${hourText}`;
        bookingDurationSelect.appendChild(option);
      });

      durationMessage.innerHTML = '<i class="fas fa-check me-1"></i>Available hours (instant loading!)';
      durationMessage.className = 'form-text text-success mt-1 small';
    }
  }
  
  // Function to update pricing based on selected duration
function updatePricing() {
const PRICING = JSON.parse(document.getElementById("pricing-config").textContent);


  const VAT = parseFloat(PRICING.vat_rate); // 0.19
  const GROSS_DAY = parseFloat(PRICING.gross_day_rental);
  const GROSS_DEALER = parseFloat(PRICING.gross_dealer);
  const GROSS_SERVICE = parseFloat(PRICING.gross_service);
  const GROSS_DRINKS = parseFloat(PRICING.gross_drinks_flatrate);
  const DEPOSIT = parseFloat(PRICING.deposit_amount);
  const drinksCheckbox = document.getElementById('drinksFlatrate');
  const dealerOn  = dealerCheckbox?.checked || false;
  const serviceOn = serviceCheckbox?.checked || false;  // ‚úÖ keep service
  const drinksOn  = drinksCheckbox?.checked || false;

  let grossTotal = GROSS_DAY; // (this is gross now)
  if (dealerOn)  grossTotal += GROSS_DEALER;
  if (serviceOn) grossTotal += GROSS_SERVICE;
  if (drinksOn)  grossTotal += GROSS_DRINKS;

  // DO NOT multiply by VAT
  window.bookingTotalAmount = grossTotal;

  console.log('grossTotal',grossTotal)

  // ‚úÖ Show/hide rows
  const finalDealerCost = document.getElementById("finalDealerCost");
  if (finalDealerCost) finalDealerCost.style.display = dealerOn ? "flex" : "none";

  const finalServiceCost = document.getElementById("finalServiceCost");
  if (finalServiceCost) finalServiceCost.style.display = serviceOn ? "flex" : "none"; // ‚úÖ fix

  const finalDrinksCost = document.getElementById("finalDrinksCost");
  if (finalDrinksCost) finalDrinksCost.style.display = drinksOn ? "flex" : "none";

  // Expose total to Stripe
  window.bookingTotalAmount = grossTotal;

  // Update UI totals
  document.getElementById("finalTotalAmount").textContent = `‚Ç¨${grossTotal.toFixed(2)}`;

  const totalAmountEl = document.getElementById("totalAmount");
  if (totalAmountEl) totalAmountEl.textContent = `‚Ç¨${grossTotal.toFixed(2)}`;
}


  // Add event listeners for service checkboxes
  const dealerCheckbox = document.getElementById('dealerService');
  const serviceCheckbox = document.getElementById('servicePersonal');
  const dealerCost = document.getElementById('dealerCost');
  const serviceCost = document.getElementById('serviceCost');
  
  if (dealerCheckbox) {
    dealerCheckbox.addEventListener('change', function() {
      if (dealerCost) dealerCost.style.display = this.checked ? 'flex' : 'none';
      updatePricing();
    });
  }
  
  if (serviceCheckbox) {
    serviceCheckbox.addEventListener('change', function() {
      if (serviceCost) serviceCost.style.display = this.checked ? 'flex' : 'none';
      updatePricing();
    });
  }
});
</script>

{% endblock %}
